<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è‹é€¸é¢æ¿ | å¤é£ç‰ˆ SUI Panel</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <!-- å¼•å…¥å­—ä½“å›¾æ ‡å¢å¼ºå¤é£è§†è§‰ -->
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    /* ========== å¤é£æ ¸å¿ƒå˜é‡ä½“ç³» ========== */
    :root{
      /* å¤é£é…è‰² - å®£çº¸/å¢¨è‰²/æœ±ç ‚/é’é»›/æœ¨è‰² */
      --bg-rice: #f5f0e6;        /* å®£çº¸åº•è‰² */
      --bg-rice-dark: #e8e0d2;    /* æ·±å®£çº¸è‰² */
      --bg-ink: #12100e;         /* å¢¨é»‘è‰² */
      --bg-wood: #8b5a2b;        /* æª€æœ¨è‰² */
      --bg-wood-light: #a67c52;  /* æµ…æœ¨è‰² */
      --red-cinnabar: #c4302b;   /* æœ±ç ‚çº¢ */
      --red-cinnabar-light: #d94843; /* æµ…æœ±ç ‚çº¢ */
      --blue-indigo: #2a5b84;    /* é’é»›è‰² */
      --blue-indigo-light: #3a7ba8; /* æµ…é’é»›è‰² */
      --green-ink: #2e5c42;      /* å¢¨ç»¿ */
      
      /* æ–‡å­—è‰² */
      --text-ink: #23201d;       /* å¢¨è‰²æ–‡å­— */
      --text-rice: #f5f0e6;      /* å®£çº¸è‰²æ–‡å­—ï¼ˆæ·±è‰²èƒŒæ™¯ç”¨ï¼‰ */
      --text-muted: #6b5b4b;     /* æµ…å¢¨è‰²ï¼ˆæ¬¡è¦æ–‡å­—ï¼‰ */
      --text-success: #2e5c42;   /* å¢¨ç»¿ï¼ˆæˆåŠŸçŠ¶æ€ï¼‰ */
      --text-danger: #c4302b;    /* æœ±ç ‚çº¢ï¼ˆå±é™©/åœç”¨ï¼‰ */
      
      /* è¾¹æ¡†/è£…é¥°è‰² */
      --border-ink: #4a4035;     /* å¢¨è‰²è¾¹æ¡† */
      --border-red: #c4302b88;   /* æœ±çº¢è¾¹æ¡†ï¼ˆåŠé€ï¼‰ */
      --border-blue: #2a5b8488;  /* é’é»›è¾¹æ¡†ï¼ˆåŠé€ï¼‰ */
      
      /* å¤é£å°ºå¯¸/åœ†è§’ - ä»¿å¤å™¨ç‰©å¼§åº¦ */
      --radius-arch: 4px;        /* ä»¿å¤æ‹±é—¨åœ†è§’ */
      --radius-seal: 2px;        /* å°ç« ç›´è§’ï¼ˆå¾®åœ†è§’ï¼‰ */
      --radius-pearl: 8px;       /* ç‰ä½©åœ†è§’ */
      
      /* é˜´å½± - æ°´å¢¨æ™•æŸ“æ•ˆæœ */
      --shadow-ink: 0 4px 8px rgba(0, 0, 0, 0.3);   /* é‡å¢¨å½± */
      --shadow-light: 0 2px 6px rgba(0, 0, 0, 0.15);/* æµ…å¢¨å½± */
      
      /* é—´è· */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 20px;
    }

    /* ========== å…¨å±€é‡ç½®ä¸åŸºç¡€æ ·å¼ ========== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* å¤é£èƒŒæ™¯ - å®£çº¸çº¹ç† + æ°´å¢¨æ¸å˜ */
    body {
      margin: 0;
      background: 
        url("https://picsum.photos/id/106/2000/2000") repeat fixed,
        linear-gradient(145deg, var(--bg-rice), var(--bg-rice-dark));
      background-blend-mode: overlay;
      color: var(--text-ink);
      /* ä¼˜å…ˆä½¿ç”¨å®‹ä½“/ä»¿å®‹ç­‰å¤é£å­—ä½“ */
      font-family: "SimSun", "STSong", "Noto Serif CJK SC", "Source Han Serif CN", serif;
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
      background-size: 200px;
    }

    /* ========== å®¹å™¨æ ·å¼ - ä»¿å¤å·è½´å¤–æ¡† ========== */
    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: var(--space-xl) var(--space-lg);
      animation: fadeIn 0.6s ease-out;
      position: relative;
      background: var(--bg-rice);
      border-left: 1px solid var(--border-ink);
      border-right: 1px solid var(--border-ink);
      box-shadow: var(--shadow-ink);
    }
    
    /* å·è½´ä¸Šä¸‹æœ¨è½´è£…é¥° */
    .wrap::before, .wrap::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      height: 16px;
      background: linear-gradient(to right, var(--bg-wood-light), var(--bg-wood), var(--bg-wood-light));
      border: 1px solid var(--border-ink);
      box-shadow: var(--shadow-ink);
      z-index: 2;
    }
    
    .wrap::before {
      top: 0;
      border-bottom: none;
      border-radius: var(--radius-arch) var(--radius-arch) 0 0;
    }
    
    .wrap::after {
      bottom: 0;
      border-top: none;
      border-radius: 0 0 var(--radius-arch) var(--radius-arch);
    }

    /* ========== å¤é£å¡ç‰‡ - ä»¿å±é£/å·è½´å†…èŠ¯ ========== */
    .card {
      background: var(--bg-rice);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-arch);
      padding: var(--space-lg);
      margin: var(--space-lg) 0;
      box-shadow: var(--shadow-ink);
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
    }
    
    /* å¡ç‰‡ä»¿å¤è™šçº¿è¾¹æ¡†è£…é¥°ï¼ˆä»¿å®£çº¸è£…è£±ï¼‰ */
    .card::before {
      content: "";
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border: 1px dashed var(--border-ink);
      pointer-events: none;
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      border-color: var(--blue-indigo);
    }
    
    .card:hover::before {
      opacity: 0.6;
      border-color: var(--blue-indigo);
    }

    /* ========== è¡Œå¸ƒå±€ ========== */
    .row {
      display: flex;
      gap: var(--space-md);
      align-items: center;
      flex-wrap: wrap;
    }
    
    .grow {
      flex: 1;
    }

    /* ========== å¤é£è¡¨å•æ§ä»¶ - ä»¿ç«¹ç®€/å®£çº¸è¾“å…¥æ¡† ========== */
    input, select, textarea {
      background: var(--bg-rice);
      color: var(--text-ink);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-seal);
      padding: 10px 12px;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--blue-indigo);
      box-shadow: 0 0 0 2px rgba(42, 91, 132, 0.2);
    }
    
    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.7;
      font-style: italic;
    }
    
    textarea {
      min-height: 72px;
      resize: vertical;
      line-height: 1.8;
    }

    /* ========== å¤é£æŒ‰é’® - ä»¿å°ç« /ç‰ä½©æ ·å¼ ========== */
    button {
      background: linear-gradient(to bottom, var(--blue-indigo-light), var(--blue-indigo));
      color: var(--text-rice);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-seal);
      padding: 10px 16px;
      font-family: inherit;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-light);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    button:hover {
      background: linear-gradient(to bottom, var(--blue-indigo), var(--blue-indigo-light));
      transform: translateY(-2px);
      box-shadow: var(--shadow-ink);
      border-color: var(--bg-ink);
    }
    
    button:active {
      transform: translateY(0);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* å±é™©æŒ‰é’® - æœ±ç ‚çº¢ï¼ˆä»¿æœ±æ‰¹ï¼‰ */
    .danger {
      background: linear-gradient(to bottom, var(--red-cinnabar-light), var(--red-cinnabar));
    }
    
    .danger:hover {
      background: linear-gradient(to bottom, var(--red-cinnabar), var(--red-cinnabar-light));
    }

    /* ========== å¤é£å¾½ç«  - ä»¿è…°ç‰Œ/ä»¤ç‰Œ ========== */
    .badge {
      padding: 4px 10px;
      border-radius: var(--radius-seal);
      border: 1px solid var(--border-ink);
      background: var(--bg-rice);
      font-size: 12px;
      font-weight: bold;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-light);
    }
    
    .status-ok {
      border-color: var(--green-ink)!important;
      color: var(--text-success)!important;
      background: rgba(46, 92, 66, 0.1);
    }
    
    .status-bad {
      border-color: var(--red-cinnabar)!important;
      color: var(--text-danger)!important;
      background: rgba(196, 48, 43, 0.1);
    }

    /* ========== æ–‡å­—æ ·å¼ ========== */
    .muted {
      color: var(--text-muted);
      font-style: italic;
    }
    
    h2, b, strong {
      color: var(--bg-ink);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    h2 {
      border-bottom: 1px solid var(--border-ink);
      padding-bottom: 8px;
      margin-bottom: 16px;
      position: relative;
    }
    
    /* æ ‡é¢˜ä¸‹çš„æœ±ç ‚ç‚¹è£…é¥° */
    h2::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 30px;
      height: 1px;
      background: var(--red-cinnabar);
    }

    /* ========== å¤é£æ ‡ç­¾é¡µ - ä»¿ä¹¦å†Œåˆ†é¡µ ========== */
    .tabs button {
      opacity: .75;
      background: var(--bg-rice);
      color: var(--text-ink);
      border: 1px solid var(--border-ink);
      padding: 8px 16px;
      text-shadow: none;
    }
    
    .tabs button.on {
      opacity: 1;
      border-color: var(--blue-indigo);
      background: rgba(42, 91, 132, 0.1);
    }
    
    .tabs button:hover {
      opacity: 1;
      background: rgba(42, 91, 132, 0.05);
      box-shadow: var(--shadow-light);
    }
    
    .tabs b {
      font-size: 18px;
      padding-right: var(--space-md);
      font-family: "KaiTi", "STKaiti", cursive; /* æ ‡é¢˜ç”¨æ¥·ä½“å¢å¼ºå¤é£ */
    }

    /* ========== ç½‘æ ¼å¸ƒå±€ ========== */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: var(--space-md);
    }

    /* ========== å¤é£æ¨¡æ€æ¡† - ä»¿å¼€çª—/å±é£ ========== */
    .m {
      position: fixed;
      inset: 0;
      background: rgba(18, 16, 14, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
      z-index: 1000;
      backdrop-filter: blur(2px);
    }
    
    .m.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .box {
      width: min(980px, 95vw);
      max-height: 90vh;
      overflow: auto;
      background: var(--bg-rice);
      border: 2px solid var(--border-ink);
      border-radius: var(--radius-arch);
      padding: var(--space-lg);
      animation: popIn 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      position: relative;
    }
    
    /* æ¨¡æ€æ¡†ä»¿å¤è§’èŠ±è£…é¥° */
    .box::before, .box::after, .box div:first-child::before, .box div:first-child::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-ink);
      opacity: 0.6;
      z-index: 1;
    }
    
    .box::before {
      top: 10px;
      left: 10px;
      border-right: none;
      border-bottom: none;
    }
    
    .box::after {
      top: 10px;
      right: 10px;
      border-left: none;
      border-bottom: none;
    }
    
    .box div:first-child::before {
      bottom: 10px;
      left: 10px;
      border-right: none;
      border-top: none;
    }
    
    .box div:first-child::after {
      bottom: 10px;
      right: 10px;
      border-left: none;
      border-top: none;
    }

    /* ========== ç™»å½•å¡ç‰‡ç‰¹æ®Šæ ·å¼ ========== */
    #login .card {
      max-width: 420px;
      margin: 12vh auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      border-width: 2px;
    }
    
    #login h2 {
      font-size: 28px;
      text-align: center;
      font-family: "KaiTi", "STKaiti", cursive;
    }
    
    #le {
      min-height: 18px;
      color: var(--text-danger);
      text-align: center;
    }

    /* ========== äºŒç»´ç æ¨¡æ€æ¡†ä¼˜åŒ– ========== */
    #qrImg {
      max-width: 320px;
      width: 100%;
      background: #fff;
      padding: var(--space-sm);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-arch);
      margin: var(--space-md) 0;
      box-shadow: var(--shadow-ink);
    }

    /* ========== åŠ¨ç”»æ•ˆæœï¼ˆå¤é£ç¼“åŠ¨ï¼‰ ========== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes popIn {
      from { opacity: .35; transform: translateY(10px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ========== å“åº”å¼é€‚é…ï¼ˆç§»åŠ¨ç«¯å¤é£å…¼å®¹ï¼‰ ========== */
    @media (max-width: 860px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .row {
        gap: var(--space-sm);
      }
      
      button {
        padding: 8px 10px;
        font-size: 13px;
      }
      
      .wrap {
        padding: var(--space-md);
      }
      
      .card {
        padding: var(--space-md);
      }
      
      .tabs button {
        padding: 6px 12px;
      }
      
      /* ç§»åŠ¨ç«¯ç®€åŒ–å·è½´è£…é¥° */
      .wrap::before, .wrap::after {
        width: 80%;
        height: 12px;
      }
    }
  </style>
</head>
<body>
<div id="login" class="wrap">
  <div class="card">
    <h2><i class="fa fa-lock"></i> è‹é€¸é¢æ¿ Â· ç™»å½•</h2>
    <div class="muted" style="margin-bottom:10px;text-align:center">å¤é£é›…éŸµ Â· ç¨³å®šè¿ç»´</div>
    <input id="lu" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" style="width:100%" />
    <input id="lp" type="password" placeholder="è¯·è¾“å…¥å¯†ç " style="width:100%;margin-top:8px" />
    <button style="width:100%;margin-top:10px" onclick="doLogin()"><i class="fa fa-sign-in"></i> ç™» å½•</button>
    <div id="le" style="margin-top:8px"></div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="card row tabs">
    <b><i class="fa fa-pagelines"></i> è‹é€¸é¢æ¿</b>
    <button id="tabMainBtn" class="on" onclick="switchTab('main')"><i class="fa fa-th"></i> èŠ‚ç‚¹ç®¡ç†</button>
    <button id="tabSettingsBtn" onclick="switchTab('settings')"><i class="fa fa-cog"></i> é¢æ¿è®¾ç½®</button>
    <button id="tabXrayBtn" onclick="switchTab('xray')"><i class="fa fa-file-text-o"></i> Xrayç®¡ç†</button>
    <span class="grow"></span>
    <button class="danger" onclick="logout()"><i class="fa fa-sign-out"></i> é€€ å‡º</button>
  </div>

  <div id="tab-main">
    <div class="card row">
      <input id="q" class="grow" placeholder="æœç´¢å¤‡æ³¨ / ç«¯å£ / åè®®" />
      <button onclick="loadData()"><i class="fa fa-refresh"></i> åˆ· æ–°</button>
      <button onclick="openAdd()"><i class="fa fa-plus"></i> æ–° å¢</button>
      <button onclick="quickReality()"><i class="fa fa-magic"></i> ä¸€é”® Reality</button>
      <button onclick="restartPanel()"><i class="fa fa-refresh"></i> é‡å¯é¢æ¿</button>
      <button onclick="restartXray()"><i class="fa fa-repeat"></i> é‡å¯Xray</button>
      <span id="cv" class="badge"><i class="fa fa-cogs"></i> å½“å‰ Xray:-</span>
    </div>

    <div class="card row">
      <b><i class="fa fa-heartbeat"></i> æœåŠ¡çŠ¶æ€</b>
      <span id="sp" class="badge">é¢æ¿:-</span>
      <span id="sx" class="badge">Xray:-</span>
      <span id="si" class="badge">èŠ‚ç‚¹:-</span>
    </div>

    <div id="list"></div>
  </div>

  <div id="tab-settings" style="display:none">
    <div class="card">
      <div id="forceResetTip" style="display:none;color:var(--text-danger);margin-bottom:8px"><i class="fa fa-exclamation-circle"></i> é¦–æ¬¡ç™»å½•è¯·å…ˆä¿®æ”¹å¯†ç </div>
      <h2><i class="fa fa-wrench"></i> é¢æ¿è®¾ç½®</h2>
      <div class="grid">
        <div>
          <div class="muted"><i class="fa fa-user"></i> ç”¨æˆ·å</div>
          <input id="set_user" style="width:100%" />
          <button style="margin-top:8px;width:100%" onclick="savePanelUsername()"><i class="fa fa-save"></i> ä¿å­˜ç”¨æˆ·å</button>
        </div>
        <div>
          <div class="muted"><i class="fa fa-path"></i> é¢æ¿è·¯å¾„</div>
          <input id="set_path" placeholder="/" style="width:100%" />
          <button style="margin-top:8px;width:100%" onclick="savePanelPath()"><i class="fa fa-save"></i> ä¿å­˜è·¯å¾„</button>
        </div>
        <div>
          <div class="muted"><i class="fa fa-key"></i> ä¿®æ”¹å¯†ç </div>
          <input id="set_old_pass" type="password" placeholder="æ—§å¯†ç ï¼ˆé¦–æ¬¡å¯ç•™ç©ºï¼‰" style="width:100%" />
          <input id="set_new_pass" type="password" placeholder="æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" style="width:100%;margin-top:8px" />
          <button style="margin-top:8px;width:100%" onclick="changePanelPassword()"><i class="fa fa-refresh"></i> æ›´æ–°å¯†ç </button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2><i class="fa fa-cogs"></i> Xray ç‰ˆæœ¬ç®¡ç†</h2>
      <div class="row">
        <span id="xvNow" class="badge">å½“å‰ Xray: - / self-hosted</span>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="xvSel" class="grow"></select>
        <input id="xvManual" placeholder="æ‰‹åŠ¨è¾“å…¥ç‰ˆæœ¬ï¼Œå¦‚ v26.2.4" style="min-width:220px" />
        <button onclick="switchXrayVersion()"><i class="fa fa-upload"></i> åˆ‡æ¢ç‰ˆæœ¬</button>
      </div>
      <div id="xvHint" class="muted" style="margin-top:8px">æç¤ºï¼šåˆ‡æ¢ä¼šè‡ªåŠ¨é‡å¯ Xray æœåŠ¡ï¼›è‹¥åˆ—è¡¨ä¸ºç©ºå¯æ‰‹åŠ¨å¡«ç‰ˆæœ¬å·ã€‚</div>
    </div>
  </div>

  <div id="tab-xray" style="display:none">
    <div class="card">
      <h2><i class="fa fa-file-code-o"></i> Xray é…ç½®æ–‡ä»¶ç®¡ç†</h2>
      <div class="row" style="margin-bottom:8px">
        <button onclick="loadXrayConfig()"><i class="fa fa-refresh"></i> è¯»å–é…ç½®</button>
        <button onclick="saveXrayConfig()"><i class="fa fa-save"></i> ä¿å­˜é…ç½®</button>
        <button onclick="restartXray()"><i class="fa fa-repeat"></i> ä¿å­˜åé‡å¯Xray</button>
        <span class="grow"></span>
        <span id="xcfgPath" class="badge">/etc/sui-xray/config.json</span>
      </div>
      <textarea id="xrayConfigText" style="width:100%;min-height:420px;font-family:monospace" placeholder="ç‚¹å‡»â€œè¯»å–é…ç½®â€åŠ è½½å½“å‰ Xray é…ç½®"></textarea>
      <div class="muted" style="margin-top:8px">è¯´æ˜ï¼šä¿å­˜æ—¶ä¼šå…ˆåš JSON æ ¡éªŒä¸ Xray é…ç½®æµ‹è¯•ï¼Œé€šè¿‡åæ‰ä¼šè½ç›˜ã€‚</div>
    </div>
  </div>
</div>

<div id="modal" class="m"><div class="box">
  <div class="row"><b id="mt"><i class="fa fa-plus-circle"></i> æ–°å¢èŠ‚ç‚¹</b><span class="grow"></span><button onclick="closeM()"><i class="fa fa-times"></i> å…³ é—­</button></div>
  <div class="grid" style="margin-top:8px">
    <input id="f_remark" placeholder="å¤‡æ³¨" />
    <input id="f_port" placeholder="ç«¯å£" />
    <select id="f_protocol"><option value="vless">vless</option><option value="vmess">vmess</option><option value="trojan">trojan</option><option value="shadowsocks">shadowsocks</option><option value="forward">port-forward</option></select>

    <select id="f_forward_protocol" data-group="forward" style="width:140px"><option value="tcp">è½¬å‘ç±»å‹ TCP</option><option value="udp">è½¬å‘ç±»å‹ UDP</option><option value="both">è½¬å‘ç±»å‹ TCP+UDP</option></select>
    <input id="f_forward_target_host" data-group="forward" placeholder="ç›®æ ‡IP/åŸŸå" />
    <input id="f_forward_target_port" data-group="forward" placeholder="ç›®æ ‡ç«¯å£" />

    <select id="f_network"><option>tcp</option><option>ws</option></select>
    <select id="f_security"><option>none</option><option>tls</option><option value="reality">reality</option></select>
    <input id="f_email" placeholder="email(tag)" />

    <select id="f_chain_enabled"><option value="0">é“¾å¼ä»£ç†ï¼šå…³é—­</option><option value="1">é“¾å¼ä»£ç†ï¼šå¼€å¯ï¼ˆç»‘å®š1ä¸ªä¸‹æ¸¸ï¼‰</option></select>
    <select id="f_chain_type" data-group="chain"><option value="socks5">ä¸‹æ¸¸ç±»å‹ socks5</option><option value="http">ä¸‹æ¸¸ç±»å‹ http</option><option value="reality">ä¸‹æ¸¸ç±»å‹ reality(vless)</option><option value="shadowsocks">ä¸‹æ¸¸ç±»å‹ shadowsocks</option></select>
    <input id="f_chain_domain" data-group="chain" placeholder="åŸŸåè§„åˆ™ï¼ˆå¯ç©ºï¼›æ”¯æŒ example.com / .example.com / api.example.comï¼Œå¤šä¸ªå¯é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰" />
    <select id="f_chain_enhance" data-group="chain"><option value="1">åŸŸååˆ†æµå¢å¼ºï¼šå¼€å¯ï¼ˆæ¨èï¼‰</option><option value="0">åŸŸååˆ†æµå¢å¼ºï¼šå…³é—­</option></select>
    <select id="f_chain_udp443_policy" data-group="chain"><option value="block">UDP/443ç­–ç•¥ï¼šæ‹¦æˆªï¼ˆæ¨èï¼‰</option><option value="direct">UDP/443ç­–ç•¥ï¼šç›´è¿</option></select>

    <input id="f_uuid" placeholder="uuid" data-group="uuid" />
    <input id="f_password" placeholder="password" data-group="password" />
    <input id="f_method" placeholder="method" data-group="method" value="aes-128-gcm" />

    <input id="f_flow" placeholder="flow(å¦‚ xtls-rprx-vision)" data-group="flow" />
    <input id="f_path" placeholder="ws path" data-group="ws" value="/" />
    <input id="f_host" placeholder="ws host" data-group="ws" />

    <input id="f_sni" placeholder="sni" data-group="tls" />
    <input id="f_realityDest" placeholder="reality dest (å¦‚ addons.mozilla.org:443)" data-group="reality" />
    <input id="f_shortId" placeholder="shortId" data-group="reality" />

    <input id="f_privateKey" placeholder="privateKey" data-group="reality" />
    <input id="f_publicKey" placeholder="publicKey(å±•ç¤ºç”¨)" data-group="reality" />

    <input id="f_chain_host" data-group="chain" placeholder="ä¸‹æ¸¸åœ°å€ host" />
    <input id="f_chain_port" data-group="chain" placeholder="ä¸‹æ¸¸ç«¯å£ port" />
    <input id="f_chain_user" data-group="chainAuth" placeholder="ä¸‹æ¸¸è´¦å·ï¼ˆhttp/sockså¯é€‰ï¼‰" />
    <input id="f_chain_pass" data-group="chainAuth" placeholder="ä¸‹æ¸¸å¯†ç ï¼ˆhttp/sockså¯é€‰ï¼‰" />

    <input id="f_chain_uuid" data-group="chainReality" placeholder="Reality ä¸‹æ¸¸ UUID" />
    <input id="f_chain_server_name" data-group="chainReality" placeholder="Reality SNI / serverName" />
    <input id="f_chain_public_key" data-group="chainReality" placeholder="Reality publicKey" />
    <input id="f_chain_short_id" data-group="chainReality" placeholder="Reality shortId" />
    <input id="f_chain_flow" data-group="chainReality" placeholder="Reality flow(é»˜è®¤ xtls-rprx-vision)" />

    <input id="f_chain_ss_method" data-group="chainSS" placeholder="SS method (é»˜è®¤ aes-128-gcm)" />
    <input id="f_chain_ss_password" data-group="chainSS" placeholder="SS password" />
  </div>
  <div class="row" style="margin-top:10px">
    <button onclick="genUUID()"><i class="fa fa-random"></i> ç”Ÿæˆ UUID</button>
    <button onclick="randSni()"><i class="fa fa-globe"></i> éšæœº SNI</button>
    <button onclick="genReality()"><i class="fa fa-key"></i> ç”Ÿæˆ Reality å¯†é’¥</button>
    <button onclick="applyNodeSpeedPreset()"><i class="fa fa-star"></i> æ¨èå‚æ•°</button>
    <button onclick="testChainConnectivity()"><i class="fa fa-plug"></i> æµ‹è¯•ä¸‹æ¸¸è¿é€šæ€§</button>
    <span class="grow"></span>
    <button onclick="submitAdd()"><i class="fa fa-save"></i> ä¿ å­˜</button>
  </div>
</div></div>

<div id="qrModal" class="m"><div class="box" style="max-width:420px">
  <div class="row"><b><i class="fa fa-qrcode"></i> äºŒç»´ç </b><span class="grow"></span><button onclick="qrModal.classList.remove('show')"><i class="fa fa-times"></i> å…³ é—­</button></div>
  <img id="qrImg" style="max-width:320px;width:100%;background:#fff;padding:8px;border-radius:8px" />
  <textarea id="qrLink" style="width:100%;min-height:72px"></textarea>
  <button onclick="navigator.clipboard.writeText(qrLink.value)"><i class="fa fa-copy"></i> å¤åˆ¶é“¾æ¥</button>
</div></div>

<script>
const $=id=>document.getElementById(id);
let all=[],forwards=[],editId=null,editForwardId=null,forceReset=false;
const sniPool=['www.lovelive-anime.jp','addons.mozilla.org','www.icloud.com','www.microsoft.com','www.apple.com','www.bing.com','www.amazon.com'];
const q=$('q'), list=$('list'), cv=$('cv'), mt=$('mt'), login=$('login'), app=$('app'), lu=$('lu'), lp=$('lp'), le=$('le');
const qrModal=$('qrModal'), qrImg=$('qrImg'), qrLink=$('qrLink'), sp=$('sp'), sx=$('sx'), si=$('si');
const fForwardProtocol=$('f_forward_protocol'), fForwardTargetHost=$('f_forward_target_host'), fForwardTargetPort=$('f_forward_target_port');
const fChainEnabled=$('f_chain_enabled'), fChainType=$('f_chain_type'), fChainDomain=$('f_chain_domain'), fChainEnhance=$('f_chain_enhance'), fChainUdp443Policy=$('f_chain_udp443_policy'), fChainHost=$('f_chain_host'), fChainPort=$('f_chain_port'), fChainUser=$('f_chain_user'), fChainPass=$('f_chain_pass');
const fChainUUID=$('f_chain_uuid'), fChainServerName=$('f_chain_server_name'), fChainPublicKey=$('f_chain_public_key'), fChainShortId=$('f_chain_short_id'), fChainFlow=$('f_chain_flow');
const fChainSSMethod=$('f_chain_ss_method'), fChainSSPassword=$('f_chain_ss_password');
const tabMain=$('tab-main'), tabSettings=$('tab-settings'), tabXray=$('tab-xray'), forceResetTip=$('forceResetTip');
const setUser=$('set_user'), setPath=$('set_path'), setOldPass=$('set_old_pass'), setNewPass=$('set_new_pass');
const xvNow=$('xvNow'), xvSel=$('xvSel'), xvManual=$('xvManual'), xvHint=$('xvHint');
const xrayConfigText=$('xrayConfigText');
let API_PREFIX='';

// æ ¸å¿ƒAPIè¯·æ±‚å‡½æ•°ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
function hdr(){const t=localStorage.sessionToken||'';return t?{'Authorization':'Bearer '+t}:{}};
function panelBasePath(){const p=location.pathname||'/';if(p==='/'||p==='')return '';if(p.endsWith('/'))return p.slice(0,-1);if(/\.html?$/.test(p))return p.replace(/\/[^/]+$/,'');return p;}
function normPrefix(p){if(!p||p==='/'||p==='null'||p==='undefined')return '';return String(p).startsWith('/')?String(p).replace(/\/$/,''):'/'+String(p).replace(/\/$/,'');}
async function api(u,o={}){const parse=async(url)=>{const r=await fetch(url,{...o,headers:{'content-type':'application/json',...hdr(),...(o.headers||{})}});const txt=await r.text();let j={};try{j=txt?JSON.parse(txt):{};}catch{j={success:false,msg:'non-json response: '+(txt||'').slice(0,120)};}if(j.success===undefined)j.success=r.ok;return j;};try{const base=normPrefix(panelBasePath());const pref=normPrefix(API_PREFIX);const tries=[];if((u.startsWith('/api/')||u.startsWith('/auth/'))&&pref)tries.push(pref+u);tries.push(u);if((u.startsWith('/api/')||u.startsWith('/auth/'))&&base&&base!==pref)tries.push(base+u);let out={success:false,msg:'uninitialized'};for(const t of tries){out=await parse(t);if(out.success||!String(out.msg||'').startsWith('non-json response'))break;}return out;}catch(e){return{success:false,msg:e?.message||'network error'}}}

// ç™»å½•é€»è¾‘ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
async function doLogin(){
  const r=await api('/auth/login',{method:'POST',body:JSON.stringify({username:lu.value,password:lp.value})});
  if(!r.success){le.textContent=r.msg||'ç™»å½•å¤±è´¥';return;}
  API_PREFIX=normPrefix(r.panelPath||'');
  localStorage.sessionToken=r.token;forceReset=!!r.mustReset;login.style.display='none';app.style.display='block';init();
  if(forceReset){switchTab('settings');forceResetTip.style.display='block';alert('é¦–æ¬¡ç™»å½•å¿…é¡»å…ˆä¿®æ”¹å¯†ç ');}
}

// é€€å‡ºç™»å½•
function logout(){localStorage.removeItem('sessionToken');location.reload();}

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(t){const main=t==='main',settings=t==='settings',xray=t==='xray';tabMain.style.display=main?'':'none';tabSettings.style.display=settings?'':'none';tabXray.style.display=xray?'':'none';$('tabMainBtn').className=main?'on':'';$('tabSettingsBtn').className=settings?'on':'';$('tabXrayBtn').className=xray?'on':'';}

// é¢æ¿è®¾ç½®ç›¸å…³ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
async function loadPanelSettings(){const r=await api('/api/panel/settings');if(!r.success)return;setUser.value=r.obj.username||'';setPath.value=r.obj.panelPath||'/';if(r.obj.forceResetPassword){forceReset=true;forceResetTip.style.display='block';}}
async function savePanelUsername(){const u=(setUser.value||'').trim();if(!u)return alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');const r=await api('/api/panel/settings',{method:'POST',body:JSON.stringify({username:u})});alert(r.success?'ç”¨æˆ·åå·²ä¿å­˜':(r.msg||'ä¿å­˜å¤±è´¥'));}
async function savePanelPath(){const p=(setPath.value||'').trim()||'/';const r=await api('/api/panel/settings',{method:'POST',body:JSON.stringify({panelPath:p})});alert(r.success?'è·¯å¾„å·²ä¿å­˜ï¼ˆé‡å¯åç”Ÿæ•ˆï¼‰':(r.msg||'ä¿å­˜å¤±è´¥'));}
async function changePanelPassword(){const np=(setNewPass.value||'').trim();if(np.length<6)return alert('æ–°å¯†ç è‡³å°‘6ä½');const r=await api('/api/panel/change-password',{method:'POST',body:JSON.stringify({oldPassword:setOldPass.value,newPassword:np})});if(!r.success)return alert(r.msg||'ä¿®æ”¹å¤±è´¥');forceReset=false;forceResetTip.style.display='none';setOldPass.value='';setNewPass.value='';alert('å¯†ç å·²æ›´æ–°');}

// æ•°æ®æ ¼å¼åŒ–ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
function bytes(n){n=Number(n||0);if(n<1024)return n+'B';if(n<1048576)return(n/1024).toFixed(1)+'KB';if(n<1073741824)return(n/1048576).toFixed(1)+'MB';return(n/1073741824).toFixed(2)+'GB';}

// åŠ è½½èŠ‚ç‚¹æ•°æ®ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
async function loadData(){const [d,f]=await Promise.all([api('/api/inbounds'),api('/api/forwards')]);if(!d.success){if((d.msg||'').includes('unauthorized')){localStorage.removeItem('sessionToken');app.style.display='none';login.style.display='block';}if(d.code==='RESET_REQUIRED'){forceReset=true;switchTab('settings');forceResetTip.style.display='block';}list.innerHTML='<div class="card">åŠ è½½å¤±è´¥ï¼š'+(d.msg||'æœªæˆæƒ')+'</div>';return;}all=d.obj||[];forwards=f.success?(f.obj||[]):[];render();}

// æ¸²æŸ“èŠ‚ç‚¹åˆ—è¡¨ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä»…ä¼˜åŒ–æ ·å¼æ–‡å­—ï¼‰
function render(){const qv=(q.value||'').toLowerCase();list.innerHTML='';const rows=all.filter(x=>`${x.remark||''} ${x.port} ${x.protocol}`.toLowerCase().includes(qv));const frows=(forwards||[]).filter(x=>`${x.remark||''} ${x.listenPort} ${x.protocol} ${x.targetHost}`.toLowerCase().includes(qv));if(!rows.length&&!frows.length){list.innerHTML='<div class="card">æš‚æ— èŠ‚ç‚¹</div>';return;}for(const i of rows){const el=document.createElement('div');el.className='card';el.innerHTML=`<div class='row' style='justify-content:space-between'><div class='row'><b>ã€#${i.id}ã€‘${i.remark||''}</b><span class='badge'>${i.protocol}</span><span class='badge'>ç«¯å£:${i.port}</span><span class='badge ${i.enable?'status-ok':'status-bad'}'>${i.enable?'å¯ç”¨':'åœç”¨'}</span></div><div class='muted'>ä¸‹è¡Œï¼š${bytes(i.down)} ä¸Šè¡Œï¼š${bytes(i.up||0)}</div></div><div class='row'><button onclick='toggle(${i.id})'><i class="fa fa-toggle-on"></i> å¼€å…³</button><button onclick='openEdit(${i.id})'><i class="fa fa-pencil"></i> ç¼–è¾‘</button><button onclick='copyLink(${i.id})'><i class="fa fa-copy"></i> å¤åˆ¶é“¾æ¥</button><button onclick='showQR(${i.id})'><i class="fa fa-qrcode"></i> äºŒç»´ç </button><button class='danger' onclick='delN(${i.id})'><i class="fa fa-trash"></i> åˆ é™¤</button></div>`;list.appendChild(el)}for(const f of frows){const el=document.createElement('div');el.className='card';el.innerHTML=`<div class='row' style='justify-content:space-between'><div class='row'><b>ã€F#${f.id}ã€‘${f.remark||'port-forward'}</b><span class='badge'>forward/${f.protocol}</span><span class='badge'>ç›‘å¬:${f.listenPort}</span><span class='badge'>ç›®æ ‡:${f.targetHost}:${f.targetPort}</span><span class='badge ${f.enabled?'status-ok':'status-bad'}'>${f.enabled?'å¯ç”¨':'åœç”¨'}</span></div><div class='muted'>ç«¯å£è½¬å‘</div></div><div class='row'><button onclick='toggleForward(${f.id})'><i class="fa fa-toggle-on"></i> å¼€å…³</button><button onclick='openEditForward(${f.id})'><i class="fa fa-pencil"></i> ç¼–è¾‘</button><button class='danger' onclick='delForward(${f.id})'><i class="fa fa-trash"></i> åˆ é™¤</button></div>`;list.appendChild(el)}}

// èŠ‚ç‚¹æ“ä½œç›¸å…³ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
async function toggle(id){await api('/api/inbounds/'+id+'/toggle',{method:'POST',body:'{}'});loadData()}
async function delN(id){if(!confirm('ç¡®è®¤åˆ é™¤æ­¤èŠ‚ç‚¹ï¼Ÿ'))return;await api('/api/inbounds/'+id,{method:'DELETE'});loadData()}
async function delForward(id){if(!confirm('ç¡®è®¤åˆ é™¤æ­¤ç«¯å£è½¬å‘ï¼Ÿ'))return;await api('/api/forwards/'+id,{method:'DELETE'});loadData()}
async function toggleForward(id){await api('/api/forwards/'+id+'/toggle',{method:'POST',body:'{}'});loadData()}
async function copyLink(id){const r=await api('/api/inbounds/'+id+'/links');if(!r.success||!r.obj?.length)return alert('æš‚æ— å¯ç”¨é“¾æ¥');await navigator.clipboard.writeText(r.obj[0]);alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')}
async function showQR(id){const r=await api('/api/inbounds/'+id+'/qr');if(!r.success)return alert(r.msg||'ç”ŸæˆäºŒç»´ç å¤±è´¥');qrImg.src=r.obj.qrDataUrl||r.obj.qrUrl||'';qrLink.value=r.obj.link||'';qrModal.classList.add('show')}

// è¡¨å•æ˜¾éšæ§åˆ¶ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
function setVis(el,show){el.style.display=show?'':'none'}
function tune(){const p=f_protocol.value,n=f_network.value;const isForward=p==='forward';if(p==='shadowsocks'||isForward){f_security.value='none';f_security.disabled=true;}else{f_security.disabled=false;}f_network.disabled=isForward;const s=f_security.value;const chainOn=fChainEnabled.value==='1';const chainType=fChainType.value;const sh={uuid:(p==='vless'||p==='vmess'),password:(p==='trojan'||p==='shadowsocks'),method:(p==='shadowsocks'),flow:(p==='vless'),ws:(!isForward&&n==='ws'),tls:(!isForward&&(s==='tls'||s==='reality')),reality:(!isForward&&s==='reality'),forward:isForward,chain:chainOn,chainAuth:chainOn&&(chainType==='socks5'||chainType==='http'),chainReality:chainOn&&chainType==='reality',chainSS:chainOn&&chainType==='shadowsocks'};document.querySelectorAll('[data-group]').forEach(el=>setVis(el,!!(sh[el.dataset.group] ?? sh[(el.dataset.group||"").replace("-","_")])))}

// å·¥å…·å‡½æ•°ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
function genUUID(){f_uuid.value=(crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx').replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
function randSni(){const s=sniPool[Math.floor(Math.random()*sniPool.length)];f_sni.value=s;if(f_security.value==='reality')f_realityDest.value=s+':443'}
async function genReality(){const r=await api('/api/system/xray/reality-gen');if(!r.success)return alert(r.msg||'ç”Ÿæˆ Reality å¯†é’¥å¤±è´¥');f_privateKey.value=r.obj.privateKey||'';f_publicKey.value=r.obj.publicKey||'';f_shortId.value=r.obj.shortId||'';if(!f_sni.value)randSni();if(!f_uuid.value)genUUID();if(!f_flow.value)f_flow.value='xtls-rprx-vision'}

// æ–°å¢/ç¼–è¾‘èŠ‚ç‚¹ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
async function openAdd(){editId=null;editForwardId=null;mt.innerHTML='<i class="fa fa-plus-circle"></i> æ–°å¢èŠ‚ç‚¹';modal.classList.add('show');const p=await api('/api/inbounds/next-port');if(p.success)f_port.value=p.obj;fForwardProtocol.value='tcp';fForwardTargetHost.value='';fForwardTargetPort.value='';fChainEnabled.value='0';fChainType.value='socks5';fChainDomain.value='';fChainEnhance.value='1';fChainUdp443Policy.value='block';fChainHost.value='';fChainPort.value='';fChainUser.value='';fChainPass.value='';fChainUUID.value='';fChainServerName.value='';fChainPublicKey.value='';fChainShortId.value='';fChainFlow.value='';fChainSSMethod.value='aes-128-gcm';fChainSSPassword.value='';genUUID();tune()}
function fill(n){if(n.protocol==='forward'){f_remark.value=n.remark||'';f_port.value=n.listenPort||'';f_protocol.value='forward';fForwardProtocol.value=n.protocol2||n.forwardProtocol||n.protocolMode||n.protocol||'tcp';fForwardTargetHost.value=n.targetHost||'';fForwardTargetPort.value=n.targetPort||'';tune();return;}const st=JSON.parse(n.settings||'{}'),ss=JSON.parse(n.streamSettings||'{}'),c=(st.clients||[])[0]||{};const ch=n.chain||{};f_remark.value=n.remark||'';f_port.value=n.port||'';f_protocol.value=n.protocol||'vless';f_network.value=ss.network||'tcp';f_security.value=ss.security||'none';f_email.value=c.email||'';f_uuid.value=c.id||'';f_password.value=c.password||'';f_method.value=c.method||'aes-128-gcm';f_flow.value=c.flow||'';f_path.value=ss.wsSettings?.path||'/';f_host.value=ss.wsSettings?.headers?.Host||'';f_sni.value=ss.tlsSettings?.serverName||ss.realitySettings?.serverNames?.[0]||'';f_realityDest.value=ss.realitySettings?.dest||'';f_shortId.value=(ss.realitySettings?.shortIds||[])[0]||'';f_privateKey.value=ss.realitySettings?.privateKey||'';f_publicKey.value='';fChainEnabled.value=ch.enabled?'1':'0';fChainType.value=ch.type||'socks5';fChainDomain.value=ch.domainFilter||'';fChainEnhance.value=ch.enhanceDomainRouting===false?'0':'1';fChainUdp443Policy.value=ch.udp443Policy||'block';fChainHost.value=ch.host||'';fChainPort.value=ch.port||'';fChainUser.value=ch.user||'';fChainPass.value=ch.pass||'';fChainUUID.value=ch.uuid||'';fChainServerName.value=ch.serverName||'';fChainPublicKey.value=ch.publicKey||'';fChainShortId.value=ch.shortId||'';fChainFlow.value=ch.flow||'';fChainSSMethod.value=ch.method||'aes-128-gcm';fChainSSPassword.value=ch.password||'';tune()}
async function openEdit(id){const n=all.find(x=>x.id===id);if(!n)return;editId=id;editForwardId=null;mt.innerHTML='<i class="fa fa-pencil"></i> ç¼–è¾‘èŠ‚ç‚¹';modal.classList.add('show');fill(n)}
async function openEditForward(id){const n=(forwards||[]).find(x=>x.id===id);if(!n)return;editId=null;editForwardId=id;mt.innerHTML='<i class="fa fa-pencil"></i> ç¼–è¾‘ç«¯å£è½¬å‘';modal.classList.add('show');fill({...n,protocol:'forward',protocol2:n.protocol});}
function closeM(){modal.classList.remove('show')}

// æäº¤èŠ‚ç‚¹ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
async function submitAdd(){const proto=f_protocol.value;if(proto==='forward'){const listenPort=Number(f_port.value||0),targetHost=(fForwardTargetHost.value||'').trim(),targetPort=Number(fForwardTargetPort.value||0),protocol=(fForwardProtocol.value||'tcp');if(!listenPort||!targetHost||!targetPort)return alert('è¯·å¡«å†™ç›‘å¬ç«¯å£/ç›®æ ‡IP/ç›®æ ‡ç«¯å£');const apiUrl=editForwardId?('/api/forwards/'+editForwardId):'/api/forwards';const apiMethod=editForwardId?'PUT':'POST';const fr=await api(apiUrl,{method:apiMethod,body:JSON.stringify({listenPort,targetHost,targetPort,protocol,remark:(f_remark.value||'')})});if(!fr.success)return alert(fr.msg||'ç«¯å£è½¬å‘ä¿å­˜å¤±è´¥');closeM();loadData();alert(protocol==='both'?'TCP+UDP ç«¯å£è½¬å‘ä¿å­˜æˆåŠŸï¼ˆå•æ¡ï¼‰':'ç«¯å£è½¬å‘ä¿å­˜æˆåŠŸ');return;}const chainEnabled=fChainEnabled.value==='1';const chain={enabled:chainEnabled,type:fChainType.value,host:(fChainHost.value||'').trim(),port:Number(fChainPort.value||0),domainFilter:(fChainDomain.value||'').trim(),enhanceDomainRouting:fChainEnhance.value==='1',udp443Policy:fChainUdp443Policy.value||'block',user:(fChainUser.value||'').trim(),pass:fChainPass.value||'',uuid:(fChainUUID.value||'').trim(),serverName:(fChainServerName.value||'').trim(),publicKey:(fChainPublicKey.value||'').trim(),shortId:(fChainShortId.value||'').trim(),flow:(fChainFlow.value||'').trim(),method:(fChainSSMethod.value||'').trim()||'aes-128-gcm',password:fChainSSPassword.value||''};if(chainEnabled&&(!chain.host||!chain.port))return alert('å·²å¼€å¯é“¾å¼ä»£ç†ï¼Œè¯·å¡«å†™ä¸‹æ¸¸ host/port');const b={remark:f_remark.value,port:f_port.value,protocol:proto,network:f_network.value,security:f_security.value,email:f_email.value,uuid:f_uuid.value,password:f_password.value,method:f_method.value,flow:f_flow.value,path:f_path.value,host:f_host.value,sni:f_sni.value,realityDest:f_realityDest.value,shortId:f_shortId.value,privateKey:f_privateKey.value,chain};const url=editId?('/api/inbounds/'+editId+'/full'):'/api/inbounds/add';const m=editId?'PUT':'POST';const r=await api(url,{method:m,body:JSON.stringify(b)});if(!r.success)return alert(r.msg||'æ“ä½œå¤±è´¥');closeM();loadData()}

// ä¸€é”® Realityï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
function randomNodeName(){const a=['sunny','lucky','silver','gentle','swift','quiet','stellar','autumn','velvet','amber'];const b=['bridge','garden','harbor','forest','island','comet','breeze','valley','summit','oasis'];return `${a[Math.floor(Math.random()*a.length)]}-${b[Math.floor(Math.random()*b.length)]}`;}
async function quickReality(){const def=randomNodeName();const remark=prompt('è¯·è¾“å…¥èŠ‚ç‚¹å¤‡æ³¨',def);if(remark===null)return;const finalName=(remark||'').trim()||def;const sni=sniPool[Math.floor(Math.random()*sniPool.length)];const r=await api('/api/inbounds/add-reality-quick',{method:'POST',body:JSON.stringify({remark:finalName,sni})});if(!r.success)return alert(r.msg||'åˆ›å»ºä¸€é”® Realityå¤±è´¥');loadData();alert('èŠ‚ç‚¹æ–°å»ºæˆåŠŸ')}
async function restartPanel(){if(!confirm('ç¡®è®¤é‡å¯é¢æ¿æœåŠ¡ï¼Ÿ'))return;const r=await api('/api/system/restart-panel',{method:'POST',body:'{}'});if(!r.success)return alert(r.msg||'é‡å¯é¢æ¿å¤±è´¥');alert('é¢æ¿å·²é‡å¯');setTimeout(()=>location.reload(),900)}
async function restartXray(){if(!confirm('ç¡®è®¤é‡å¯ Xray æœåŠ¡ï¼Ÿ'))return;const r=await api('/api/system/restart-xray',{method:'POST',body:'{}'});if(!r.success)return alert(r.msg||'é‡å¯ Xray å¤±è´¥');alert('Xray å·²é‡å¯');await Promise.all([loadCur(),loadStatus()])}
async function loadXrayConfig(){const r=await api('/api/system/xray/config');if(!r.success)return alert(r.msg||'è¯»å–é…ç½®å¤±è´¥');xrayConfigText.value=r.obj?.content||''}
async function saveXrayConfig(){const content=(xrayConfigText.value||'').trim();if(!content)return alert('é…ç½®å†…å®¹ä¸èƒ½ä¸ºç©º');const r=await api('/api/system/xray/config',{method:'POST',body:JSON.stringify({content})});if(!r.success)return alert(r.msg||'ä¿å­˜é…ç½®å¤±è´¥');alert(r.msg||'é…ç½®ä¿å­˜æˆåŠŸ')}
async function testChainConnectivity(){if(fChainEnabled.value!=='1')return alert('è¯·å…ˆå¼€å¯é“¾å¼ä»£ç†');const host=(fChainHost.value||'').trim();const port=Number(fChainPort.value||0);if(!host||!port)return alert('è¯·å…ˆå¡«å†™ä¸‹æ¸¸ host/port');const r=await api('/api/system/chain/test',{method:'POST',body:JSON.stringify({host,port})});alert(r.success?'ä¸‹æ¸¸è¿é€šæ€§æ­£å¸¸':(r.msg||'è¿é€šæ€§å¤±è´¥'))}
function applyNodeSpeedPreset(){f_protocol.value='vless';f_network.value='tcp';f_security.value='reality';if(!f_flow.value)f_flow.value='xtls-rprx-vision';if(!f_sni.value)randSni();if(!f_realityDest.value&&f_sni.value)f_realityDest.value=f_sni.value+':443';if(!f_uuid.value)genUUID();tune();alert('å·²åº”ç”¨æ¨èå‚æ•°')}

// åŠ è½½å¼•æ“ä¿¡æ¯ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
async function loadCur(){const r=await api('/api/system/xray/version-current');if(r.success){cv.textContent=`ğŸ“œ å½“å‰ Xray: ${(r.obj.binary||'-')} / ${(r.obj.panel||'-')}`;return;}cv.textContent='ğŸ“œ å½“å‰ Xray: è·å–å¤±è´¥'}

// åŠ è½½çŠ¶æ€ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
let __lastStatus='';
async function loadStatus(){const r=await api('/api/system/status');if(!r.success){sp.textContent='é¢æ¿:ä¸æ­£å¸¸';sx.textContent='Xray:ä¸æ­£å¸¸';si.textContent='èŠ‚ç‚¹:ä¸æ­£å¸¸';sp.title=sx.title=si.title=(r.msg||'çŠ¶æ€è·å–å¤±è´¥');sp.className='badge status-bad';sx.className='badge status-bad';return;}const o=r.obj||{};const ok=v=>v==='active';const ptxt=ok(o.panel?.active)?'æ­£å¸¸':'ä¸æ­£å¸¸';const xtxt=ok(o.xray?.active)?'æ­£å¸¸':'ä¸æ­£å¸¸';const next=`${ptxt}|${xtxt}|${o.xrayVersion||''}|${o.inboundsEnabled??'-'}/${o.inboundsTotal??'-'}`;if(next===__lastStatus)return;__lastStatus=next;sp.textContent=`é¢æ¿:${ptxt}`;sp.className='badge '+(ok(o.panel?.active)?'status-ok':'status-bad');sx.textContent=`Xray:${xtxt}${o.xrayVersion?(' Â· '+o.xrayVersion):''}`;sx.className='badge '+(ok(o.xray?.active)?'status-ok':'status-bad');si.textContent=`èŠ‚ç‚¹:${(o.inboundsEnabled??'-')}/${(o.inboundsTotal??'-')}`}


async function loadXrayVersions(){
  const [cur,vers]=await Promise.all([api('/api/system/xray/version-current'),api('/api/system/xray/versions')]);
  if(cur.success){
    xvNow.textContent=`å½“å‰ Xray: ${(cur.obj.binary||'-')} / ${(cur.obj.panel||'self-hosted')}`;
    if(xvManual && !xvManual.value && cur.obj.binary) xvManual.value=String(cur.obj.binary).startsWith('v')?cur.obj.binary:('v'+cur.obj.binary);
  }
  xvSel.innerHTML='';
  if(vers.success&&Array.isArray(vers.obj)&&vers.obj.length){
    for(const v of vers.obj){const o=document.createElement('option');o.value=v;o.textContent=v;xvSel.appendChild(o)}
    if(xvHint) xvHint.textContent='æç¤ºï¼šé€‰æ‹©ç‰ˆæœ¬ååˆ‡æ¢ï¼Œä¼šè‡ªåŠ¨é‡å¯ Xray æœåŠ¡ã€‚';
  }else{
    const o=document.createElement('option');o.value='';o.textContent='(ç‰ˆæœ¬åˆ—è¡¨è·å–å¤±è´¥ï¼Œå¯å³ä¾§æ‰‹åŠ¨è¾“å…¥)';xvSel.appendChild(o);
    if(xvHint) xvHint.textContent='æç¤ºï¼šç‰ˆæœ¬åˆ—è¡¨è·å–å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œåŸå› ï¼‰ï¼Œå¯æ‰‹åŠ¨å¡« v26.2.4 è¿™ç§æ ¼å¼ååˆ‡æ¢ã€‚';
  }
}
async function switchXrayVersion(){
  const picked=(xvSel.value||'').trim();
  let v=(xvManual?.value||'').trim() || picked;
  if(!v) return alert('è¯·é€‰æ‹©æˆ–è¾“å…¥ç‰ˆæœ¬');
  if(!v.startsWith('v')) v='v'+v;
  if(!confirm(`ç¡®è®¤åˆ‡æ¢åˆ° ${v} ?`)) return;
  const r=await api('/api/system/xray/switch',{method:'POST',body:JSON.stringify({version:v})});
  if(!r.success) return alert(r.msg||'åˆ‡æ¢å¤±è´¥');
  alert('åˆ‡æ¢æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°çŠ¶æ€');
  await Promise.all([loadCur(),loadStatus(),loadXrayVersions()]);
}

// åˆå§‹åŒ–ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
async function init(){let __qTimer=null;q.oninput=()=>{clearTimeout(__qTimer);__qTimer=setTimeout(render,120)};f_protocol.onchange=tune;f_network.onchange=tune;f_security.onchange=tune;fChainEnabled.onchange=tune;fChainType.onchange=tune;fChainEnhance.onchange=tune;fChainUdp443Policy.onchange=tune;switchTab('main');
  await Promise.all([loadPanelSettings(),loadCur(),loadStatus(),loadXrayVersions()]);
  if(!forceReset)loadData();
  setInterval(loadStatus,15000)
}

// é¡µé¢å¯åŠ¨é€»è¾‘ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
(async()=>{if(localStorage.sessionToken){const me=await api('/auth/me');if(me.success){API_PREFIX=normPrefix(me.panelPath||'');forceReset=!!me.mustReset;login.style.display='none';app.style.display='block';init();if(forceReset){switchTab('settings');forceResetTip.style.display='block';}return;}localStorage.removeItem('sessionToken');}login.style.display='block';app.style.display='none';})();
</script>
</body>
</html>