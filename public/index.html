<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>苏逸面板</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <!-- 引入字体图标增强古风视觉 -->
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    /* ========== 古风核心变量体系 ========== */
    :root{
      /* 古风配色 - 宣纸/墨色/朱砂/青黛/木色 */
      --bg-rice: #f5f0e6;        /* 宣纸底色 */
      --bg-rice-dark: #e8e0d2;    /* 深宣纸色 */
      --bg-ink: #12100e;         /* 墨黑色 */
      --bg-wood: #8b5a2b;        /* 檀木色 */
      --bg-wood-light: #a67c52;  /* 浅木色 */
      --red-cinnabar: #c4302b;   /* 朱砂红 */
      --red-cinnabar-light: #d94843; /* 浅朱砂红 */
      --blue-indigo: #2a5b84;    /* 青黛色 */
      --blue-indigo-light: #3a7ba8; /* 浅青黛色 */
      --green-ink: #2e5c42;      /* 墨绿 */
      
      /* 文字色 */
      --text-ink: #23201d;       /* 墨色文字 */
      --text-rice: #f5f0e6;      /* 宣纸色文字（深色背景用） */
      --text-muted: #6b5b4b;     /* 浅墨色（次要文字） */
      --text-success: #2e5c42;   /* 墨绿（成功状态） */
      --text-danger: #c4302b;    /* 朱砂红（危险/停用） */
      
      /* 边框/装饰色 */
      --border-ink: #4a4035;     /* 墨色边框 */
      --border-red: #c4302b88;   /* 朱红边框（半透） */
      --border-blue: #2a5b8488;  /* 青黛边框（半透） */
      
      /* 古风尺寸/圆角 - 仿古器物弧度 */
      --radius-arch: 4px;        /* 仿古拱门圆角 */
      --radius-seal: 2px;        /* 印章直角（微圆角） */
      --radius-pearl: 8px;       /* 玉佩圆角 */
      
      /* 阴影 - 水墨晕染效果 */
      --shadow-ink: 0 4px 8px rgba(0, 0, 0, 0.3);   /* 重墨影 */
      --shadow-light: 0 2px 6px rgba(0, 0, 0, 0.15);/* 浅墨影 */
      
      /* 间距 */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 20px;
    }

    /* ========== 全局重置与基础样式 ========== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* 古风背景 - 宣纸纹理 + 水墨渐变 */
    body {
      margin: 0;
      background: 
        url("https://picsum.photos/id/106/2000/2000") repeat fixed,
        linear-gradient(145deg, var(--bg-rice), var(--bg-rice-dark));
      background-blend-mode: overlay;
      color: var(--text-ink);
      /* 优先使用宋体/仿宋等古风字体 */
      font-family: "SimSun", "STSong", "Noto Serif CJK SC", "Source Han Serif CN", serif;
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
      background-size: 200px;
    }

    /* ========== 容器样式 - 仿古卷轴外框 ========== */
    .wrap {
      max-width: 1120px;
      margin: 0 auto;
      padding: var(--space-xl) var(--space-lg);
      animation: fadeIn 0.6s ease-out;
      position: relative;
      background: var(--bg-rice);
      border-left: 1px solid var(--border-ink);
      border-right: 1px solid var(--border-ink);
      box-shadow: var(--shadow-ink);
    }
    
    /* 卷轴上下木轴装饰 */
    .wrap::before, .wrap::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      height: 16px;
      background: linear-gradient(to right, var(--bg-wood-light), var(--bg-wood), var(--bg-wood-light));
      border: 1px solid var(--border-ink);
      box-shadow: var(--shadow-ink);
      z-index: 2;
    }
    
    .wrap::before {
      top: 0;
      border-bottom: none;
      border-radius: var(--radius-arch) var(--radius-arch) 0 0;
    }
    
    .wrap::after {
      bottom: 0;
      border-top: none;
      border-radius: 0 0 var(--radius-arch) var(--radius-arch);
    }

    /* ========== 古风卡片 - 仿屏风/卷轴内芯 ========== */
    .card {
      background: var(--bg-rice);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-arch);
      padding: var(--space-lg);
      margin: var(--space-lg) 0;
      box-shadow: var(--shadow-ink);
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
    }
    
    /* 卡片仿古虚线边框装饰（仿宣纸装裱） */
    .card::before {
      content: "";
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border: 1px dashed var(--border-ink);
      pointer-events: none;
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      border-color: var(--blue-indigo);
    }
    
    .card:hover::before {
      opacity: 0.6;
      border-color: var(--blue-indigo);
    }

    /* ========== 行布局 ========== */
    .row {
      display: flex;
      gap: var(--space-md);
      align-items: center;
      flex-wrap: wrap;
    }
    
    .grow {
      flex: 1;
    }

    /* ========== 古风表单控件 - 仿竹简/宣纸输入框 ========== */
    input, select, textarea {
      background: var(--bg-rice);
      color: var(--text-ink);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-seal);
      padding: 10px 12px;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--blue-indigo);
      box-shadow: 0 0 0 2px rgba(42, 91, 132, 0.2);
    }
    
    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.7;
      font-style: italic;
    }
    
    textarea {
      min-height: 72px;
      resize: vertical;
      line-height: 1.8;
    }

    /* ========== 古风按钮 - 仿印章/玉佩样式 ========== */
    button {
      background: linear-gradient(to bottom, var(--blue-indigo-light), var(--blue-indigo));
      color: var(--text-rice);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-seal);
      padding: 10px 16px;
      font-family: inherit;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-light);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    button:hover {
      background: linear-gradient(to bottom, var(--blue-indigo), var(--blue-indigo-light));
      transform: translateY(-2px);
      box-shadow: var(--shadow-ink);
      border-color: var(--bg-ink);
    }
    
    button:active {
      transform: translateY(0);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* 危险按钮 - 朱砂红（仿朱批） */
    .danger {
      background: linear-gradient(to bottom, var(--red-cinnabar-light), var(--red-cinnabar));
    }
    
    .danger:hover {
      background: linear-gradient(to bottom, var(--red-cinnabar), var(--red-cinnabar-light));
    }

    /* ========== 古风徽章 - 仿腰牌/令牌 ========== */
    .badge {
      padding: 4px 10px;
      border-radius: var(--radius-seal);
      border: 1px solid var(--border-ink);
      background: var(--bg-rice);
      font-size: 12px;
      font-weight: bold;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-light);
    }
    
    .status-ok {
      border-color: var(--green-ink)!important;
      color: var(--text-success)!important;
      background: rgba(46, 92, 66, 0.1);
    }
    
    .status-bad {
      border-color: var(--red-cinnabar)!important;
      color: var(--text-danger)!important;
      background: rgba(196, 48, 43, 0.1);
    }

    /* ========== 文字样式 ========== */
    .muted {
      color: var(--text-muted);
      font-style: italic;
    }
    
    h2, b, strong {
      color: var(--bg-ink);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    h2 {
      border-bottom: 1px solid var(--border-ink);
      padding-bottom: 8px;
      margin-bottom: 16px;
      position: relative;
    }
    
    /* 标题下的朱砂点装饰 */
    h2::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 30px;
      height: 1px;
      background: var(--red-cinnabar);
    }

    /* ========== 古风标签页 - 仿书册分页 ========== */
    .tabs button {
      opacity: .75;
      background: var(--bg-rice);
      color: var(--text-ink);
      border: 1px solid var(--border-ink);
      padding: 8px 16px;
      text-shadow: none;
    }
    
    .tabs button.on {
      opacity: 1;
      border-color: var(--blue-indigo);
      background: rgba(42, 91, 132, 0.1);
    }
    
    .tabs button:hover {
      opacity: 1;
      background: rgba(42, 91, 132, 0.05);
      box-shadow: var(--shadow-light);
    }
    
    .tabs b {
      font-size: 18px;
      padding-right: var(--space-md);
      font-family: "KaiTi", "STKaiti", cursive; /* 标题用楷体增强古风 */
    }

    /* ========== 网格布局 ========== */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: var(--space-md);
    }

    /* ========== 古风模态框 - 仿开窗/屏风 ========== */
    .m {
      position: fixed;
      inset: 0;
      background: rgba(18, 16, 14, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s ease;
      z-index: 1000;
      backdrop-filter: blur(2px);
    }
    
    .m.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .box {
      width: min(980px, 95vw);
      max-height: 90vh;
      overflow: auto;
      background: var(--bg-rice);
      border: 2px solid var(--border-ink);
      border-radius: var(--radius-arch);
      padding: var(--space-lg);
      animation: popIn 0.3s ease;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      position: relative;
    }
    
    /* 模态框仿古角花装饰 */
    .box::before, .box::after, .box div:first-child::before, .box div:first-child::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-ink);
      opacity: 0.6;
      z-index: 1;
    }
    
    .box::before {
      top: 10px;
      left: 10px;
      border-right: none;
      border-bottom: none;
    }
    
    .box::after {
      top: 10px;
      right: 10px;
      border-left: none;
      border-bottom: none;
    }
    
    .box div:first-child::before {
      bottom: 10px;
      left: 10px;
      border-right: none;
      border-top: none;
    }
    
    .box div:first-child::after {
      bottom: 10px;
      right: 10px;
      border-left: none;
      border-top: none;
    }

    /* ========== 登录卡片特殊样式 ========== */
    #login .card {
      max-width: 420px;
      margin: 12vh auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      border-width: 2px;
    }
    
    #login h2 {
      font-size: 28px;
      text-align: center;
      font-family: "KaiTi", "STKaiti", cursive;
    }
    
    #le {
      min-height: 18px;
      color: var(--text-danger);
      text-align: center;
    }

    /* ========== 二维码模态框优化 ========== */
    #qrImg {
      max-width: 320px;
      width: 100%;
      background: #fff;
      padding: var(--space-sm);
      border: 1px solid var(--border-ink);
      border-radius: var(--radius-arch);
      margin: var(--space-md) 0;
      box-shadow: var(--shadow-ink);
    }

    /* ========== 动画效果（古风缓动） ========== */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes popIn {
      from { opacity: .35; transform: translateY(10px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* ========== 响应式适配（移动端古风兼容） ========== */
    @media (max-width: 860px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .row {
        gap: var(--space-sm);
      }
      
      button {
        padding: 8px 10px;
        font-size: 13px;
      }
      
      .wrap {
        padding: var(--space-md);
      }
      
      .card {
        padding: var(--space-md);
      }
      
      .tabs button {
        padding: 6px 12px;
      }
      
      /* 移动端简化卷轴装饰 */
      .wrap::before, .wrap::after {
        width: 80%;
        height: 12px;
      }
    }
  
.toast-wrap{position:fixed;right:16px;top:16px;z-index:99999;display:flex;flex-direction:column;gap:8px}
.toast{background:#12213f;border:1px solid #345ea8;color:#eaf1ff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.35);font-size:13px;max-width:340px;opacity:.98}
.toast.ok{border-color:#2f7d4a}
.toast.err{border-color:#8a2f46}

.traffic-stat{font-size:15px;font-weight:700;color:#1f2f55;letter-spacing:.2px;background:rgba(42,91,132,.08);border:1px solid var(--border-blue);padding:4px 8px;border-radius:8px}

.proxy-auth-toggle{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border-ink);border-radius:var(--radius-seal);background:var(--bg-rice)}
.switch{position:relative;display:inline-block;width:50px;height:28px}
.switch input{display:none}
.slider{position:absolute;inset:0;background:#9aa3b2;border:1px solid #6b7280;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:22px;width:22px;left:2px;top:2px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 3px rgba(0,0,0,.35)}
.switch input:checked + .slider{background:#2a7b4f;border-color:#1d5e3b}
.switch input:checked + .slider:before{transform:translateX(22px)}

</style>
</head>
<body>
<div id="login" class="wrap">
  <div class="card">
    <h2><i class="fa fa-lock"></i> 苏逸面板 · 登录</h2>
    <div class="muted" style="margin-bottom:10px;text-align:center">古风雅韵 · 稳定运维</div>
    <input id="lu" placeholder="请输入用户名" style="width:100%" />
    <input id="lp" type="password" placeholder="请输入密码" style="width:100%;margin-top:8px" />
    <button style="width:100%;margin-top:10px" onclick="doLogin()"><i class="fa fa-sign-in"></i> 登 录</button>
    <div id="le" style="margin-top:8px"></div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="card row tabs">
    <b><i class="fa fa-pagelines"></i> 苏逸面板</b>
    <button id="tabMainBtn" class="on" onclick="switchTab('main')"><i class="fa fa-th"></i> 节点管理</button>
    <button id="tabSettingsBtn" onclick="switchTab('settings')"><i class="fa fa-cog"></i> 面板设置</button>
    <button id="tabXrayBtn" onclick="switchTab('xray')"><i class="fa fa-file-text-o"></i> Xray管理</button>
    <span class="grow"></span>
    <button class="danger" onclick="logout()"><i class="fa fa-sign-out"></i> 退 出</button>
  </div>

  <div id="tab-main">
    <div class="card row">
      <input id="q" class="grow" placeholder="搜索备注 / 端口 / 协议" />
      <button onclick="loadData()"><i class="fa fa-refresh"></i> 刷 新</button>
      <button onclick="resetTrafficStats()"><i class="fa fa-eraser"></i> 清空流量统计</button>
      <button onclick="openAdd()"><i class="fa fa-plus"></i> 新 增</button>
      <button onclick="quickReality()"><i class="fa fa-magic"></i> 一键 Reality</button>
      <button onclick="restartPanel()"><i class="fa fa-refresh"></i> 重启面板</button>
      <button onclick="restartXray()"><i class="fa fa-repeat"></i> 重启Xray</button>
      <span id="cv" class="badge"><i class="fa fa-cogs"></i> 当前 Xray:-</span>
    </div>

    <div class="card row">
      <b><i class="fa fa-heartbeat"></i> 服务状态</b>
      <span id="sp" class="badge">面板:-</span>
      <span id="sx" class="badge">Xray:-</span>
      <span id="si" class="badge">节点:-</span>
    </div>

    <div id="list"></div>
  </div>

  <div id="tab-settings" style="display:none">
    <div class="card">
      <div id="forceResetTip" style="display:none;color:var(--text-danger);margin-bottom:8px"><i class="fa fa-exclamation-circle"></i> 首次登录请先修改密码</div>
      <h2><i class="fa fa-wrench"></i> 面板设置</h2>
      <div class="grid">
        <div>
          <div class="muted"><i class="fa fa-user"></i> 用户名</div>
          <input id="set_user" style="width:100%" />
          <button style="margin-top:8px;width:100%" onclick="savePanelUsername()"><i class="fa fa-save"></i> 保存用户名</button>
        </div>
        <div>
          <div class="muted"><i class="fa fa-path"></i> 面板路径</div>
          <input id="set_path" placeholder="/" style="width:100%" />
          <button style="margin-top:8px;width:100%" onclick="savePanelPath()"><i class="fa fa-save"></i> 保存路径</button>
        </div>
        <div>
          <div class="muted"><i class="fa fa-key"></i> 修改密码</div>
          <input id="set_old_pass" type="password" placeholder="旧密码（首次可留空）" style="width:100%" />
          <input id="set_new_pass" type="password" placeholder="新密码（至少6位）" style="width:100%;margin-top:8px" />
          <button style="margin-top:8px;width:100%" onclick="changePanelPassword()"><i class="fa fa-refresh"></i> 更新密码</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2><i class="fa fa-cogs"></i> Xray 版本管理</h2>
      <div class="row">
        <span id="xvNow" class="badge">当前 Xray: - / self-hosted</span>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="xvSel" class="grow"></select>
        <button onclick="switchXrayVersion()"><i class="fa fa-upload"></i> 立即安装所选版本</button>
      </div>
      <div id="xvHint" class="muted" style="margin-top:8px">提示：下拉选择版本后点按钮即可安装，安装完成会自动重启 Xray 服务。</div>
    </div>
  </div>

  <div id="tab-xray" style="display:none">
    <div class="card">
      <h2><i class="fa fa-file-code-o"></i> Xray 配置文件管理</h2>
      <div class="row" style="margin-bottom:8px">
        <button onclick="loadXrayConfig()"><i class="fa fa-refresh"></i> 读取配置</button>
        <button onclick="saveXrayConfig()"><i class="fa fa-save"></i> 保存配置</button>
        <button onclick="restartXray()"><i class="fa fa-repeat"></i> 保存后重启Xray</button>
        <span class="grow"></span>
        <span id="xcfgPath" class="badge">/etc/sui-xray/config.json</span>
      </div>
      <textarea id="xrayConfigText" style="width:100%;min-height:420px;font-family:monospace" placeholder="点击“读取配置”加载当前 Xray 配置"></textarea>
      <div class="muted" style="margin-top:8px">说明：保存时会先做 JSON 校验与 Xray 配置测试，通过后才会落盘。</div>
    </div>
  </div>
</div>

<div id="modal" class="m"><div class="box">
  <div class="row"><b id="mt"><i class="fa fa-plus-circle"></i> 新增节点</b><span class="grow"></span><button onclick="closeM()"><i class="fa fa-times"></i> 关 闭</button></div>
  <div class="grid" style="margin-top:8px">
    <input id="f_remark" placeholder="备注" />
    <input id="f_port" placeholder="端口" />
    <select id="f_protocol"><option value="vless">vless</option><option value="vmess">vmess</option><option value="trojan">trojan</option><option value="shadowsocks">shadowsocks</option><option value="socks">socks</option><option value="http">http</option><option value="forward">port-forward</option></select>

    <select id="f_forward_protocol" data-group="forward" style="width:140px"><option value="tcp">转发类型 TCP</option><option value="udp">转发类型 UDP</option><option value="both">转发类型 TCP+UDP</option></select>
    <input id="f_forward_target_host" data-group="forward" placeholder="目标IP/域名" />
    <input id="f_forward_target_port" data-group="forward" placeholder="目标端口" />

    <select id="f_network"><option>tcp</option><option>ws</option></select>
    <select id="f_security"><option>none</option><option>tls</option><option value="reality">reality</option></select>
    <input id="f_email" placeholder="email(tag)" />
    <div class="proxy-auth-toggle" data-group="userAuth"><span>认证开关</span><label class="switch"><input id="f_auth_enabled" type="checkbox" /><span class="slider"></span></label><span class="muted">开启后自动填账号密码</span></div>
    <input id="f_user" placeholder="user(用于 socks/http 认证)" data-group="user" />
    <input id="f_password" placeholder="password(用于 socks/http 认证)" data-group="password" />

    <select id="f_chain_enabled"><option value="0">链式代理：关闭</option><option value="1">链式代理：开启（绑定1个下游）</option></select>
    <select id="f_chain_type" data-group="chain"><option value="socks5">下游类型 socks5</option><option value="http">下游类型 http</option><option value="reality">下游类型 reality(vless)</option><option value="shadowsocks">下游类型 shadowsocks</option></select>
    <input id="f_chain_domain" data-group="chain" placeholder="域名规则（可空；支持 example.com / .example.com / api.example.com，多个可逗号或换行分隔）" />
    <select id="f_chain_enhance" data-group="chain"><option value="1">域名分流增强：开启（推荐）</option><option value="0">域名分流增强：关闭</option></select>
    <select id="f_chain_udp443_policy" data-group="chain"><option value="block">UDP/443策略：拦截（推荐）</option><option value="direct">UDP/443策略：直连</option></select>

    <input id="f_uuid" placeholder="uuid" data-group="uuid" />
    <input id="f_method" placeholder="method" data-group="method" value="aes-128-gcm" />

    <input id="f_flow" placeholder="flow(如 xtls-rprx-vision)" data-group="flow" />
    <input id="f_path" placeholder="ws path" data-group="ws" value="/" />
    <input id="f_host" placeholder="ws host" data-group="ws" />

    <input id="f_sni" placeholder="sni" data-group="tls" />
    <input id="f_realityDest" placeholder="reality dest (如 addons.mozilla.org:443)" data-group="reality" />
    <input id="f_shortId" placeholder="shortId（自动生成，可手改）" data-group="reality" />

    <input id="f_privateKey" placeholder="privateKey（自动生成，可手改）" data-group="reality" />
    <input id="f_publicKey" placeholder="publicKey（自动生成展示）" data-group="reality" />

    <input id="f_chain_host" data-group="chain" placeholder="下游地址 host" />
    <input id="f_chain_port" data-group="chain" placeholder="下游端口 port" />
    <input id="f_chain_user" data-group="chainAuth" placeholder="下游账号（http/socks可选）" />
    <input id="f_chain_pass" data-group="chainAuth" placeholder="下游密码（http/socks可选）" />

    <input id="f_chain_uuid" data-group="chainReality" placeholder="Reality 下游 UUID" />
    <input id="f_chain_server_name" data-group="chainReality" placeholder="Reality SNI / serverName" />
    <input id="f_chain_public_key" data-group="chainReality" placeholder="Reality publicKey" />
    <input id="f_chain_short_id" data-group="chainReality" placeholder="Reality shortId" />
    <input id="f_chain_flow" data-group="chainReality" placeholder="Reality flow(默认 xtls-rprx-vision)" />

    <input id="f_chain_ss_method" data-group="chainSS" placeholder="SS method (默认 aes-128-gcm)" />
    <input id="f_chain_ss_password" data-group="chainSS" placeholder="SS password" />
  </div>
  <div class="row" style="margin-top:10px">
    <button data-group="realityTools" onclick="genUUID()"><i class="fa fa-random"></i> 生成 UUID</button>
    <button data-group="realityTools" onclick="randSni()"><i class="fa fa-globe"></i> 随机 SNI</button>
    <button data-group="chain" onclick="testChainConnectivity()"><i class="fa fa-plug"></i> 测试下游连通性</button>
    <span class="grow"></span>
    <button onclick="submitAdd()"><i class="fa fa-save"></i> 保 存</button>
  </div>
</div></div>

<div id="qrModal" class="m"><div class="box" style="max-width:420px">
  <div class="row"><b><i class="fa fa-qrcode"></i> 二维码</b><span class="grow"></span><button onclick="qrModal.classList.remove('show')"><i class="fa fa-times"></i> 关 闭</button></div>
  <img id="qrImg" style="max-width:320px;width:100%;background:#fff;padding:8px;border-radius:8px" />
  <textarea id="qrLink" style="width:100%;min-height:72px"></textarea>
  <button onclick="navigator.clipboard.writeText(qrLink.value)"><i class="fa fa-copy"></i> 复制链接</button>
</div></div>

<div id="toastWrap" class="toast-wrap"></div>

<script>
const $=id=>document.getElementById(id);
let all=[],forwards=[],editId=null,editForwardId=null,forceReset=false;
const NODE_DRAFT_KEY='sui_node_draft_v1';

function notify(msg,type='ok',ms=2200){
  const w=document.getElementById('toastWrap');
  if(!w) return;
  const el=document.createElement('div');
  el.className='toast '+(type==='err'?'err':'ok');
  el.textContent=String(msg||'完成');
  w.appendChild(el);
  setTimeout(()=>{el.style.opacity='0';el.style.transition='opacity .25s ease';},Math.max(300,ms-250));
  setTimeout(()=>el.remove(),ms);
}

const sniPool=['www.lovelive-anime.jp','addons.mozilla.org','www.icloud.com','www.microsoft.com','www.apple.com','www.bing.com','www.amazon.com'];
const q=$('q'), list=$('list'), cv=$('cv'), mt=$('mt'), login=$('login'), app=$('app'), lu=$('lu'), lp=$('lp'), le=$('le');
const qrModal=$('qrModal'), qrImg=$('qrImg'), qrLink=$('qrLink'), sp=$('sp'), sx=$('sx'), si=$('si');
const fForwardProtocol=$('f_forward_protocol'), fForwardTargetHost=$('f_forward_target_host'), fForwardTargetPort=$('f_forward_target_port');
const fUser=$('f_user');
const fAuthEnabled=$('f_auth_enabled');
const fChainEnabled=$('f_chain_enabled'), fChainType=$('f_chain_type'), fChainDomain=$('f_chain_domain'), fChainEnhance=$('f_chain_enhance'), fChainUdp443Policy=$('f_chain_udp443_policy'), fChainHost=$('f_chain_host'), fChainPort=$('f_chain_port'), fChainUser=$('f_chain_user'), fChainPass=$('f_chain_pass');
const fChainUUID=$('f_chain_uuid'), fChainServerName=$('f_chain_server_name'), fChainPublicKey=$('f_chain_public_key'), fChainShortId=$('f_chain_short_id'), fChainFlow=$('f_chain_flow');
const fChainSSMethod=$('f_chain_ss_method'), fChainSSPassword=$('f_chain_ss_password');
const tabMain=$('tab-main'), tabSettings=$('tab-settings'), tabXray=$('tab-xray'), forceResetTip=$('forceResetTip');
const setUser=$('set_user'), setPath=$('set_path'), setOldPass=$('set_old_pass'), setNewPass=$('set_new_pass');
const xvNow=$('xvNow'), xvSel=$('xvSel'), xvHint=$('xvHint');
const xrayConfigText=$('xrayConfigText');
let API_PREFIX='';

// 核心API请求函数（保留原有逻辑）
function hdr(){const t=localStorage.sessionToken||'';return t?{'Authorization':'Bearer '+t}:{}};
function panelBasePath(){const p=location.pathname||'/';if(p==='/'||p==='')return '';if(p.endsWith('/'))return p.slice(0,-1);if(/\.html?$/.test(p))return p.replace(/\/[^/]+$/,'');return p;}
function normPrefix(p){if(!p||p==='/'||p==='null'||p==='undefined')return '';return String(p).startsWith('/')?String(p).replace(/\/$/,''):'/'+String(p).replace(/\/$/,'');}
async function api(u,o={}){const parse=async(url)=>{const r=await fetch(url,{...o,headers:{'content-type':'application/json',...hdr(),...(o.headers||{})}});const txt=await r.text();let j={};try{j=txt?JSON.parse(txt):{};}catch{j={success:false,msg:'non-json response: '+(txt||'').slice(0,120)};}if(j.success===undefined)j.success=r.ok;return j;};try{const base=normPrefix(panelBasePath());const pref=normPrefix(API_PREFIX);const tries=[];if((u.startsWith('/api/')||u.startsWith('/auth/'))&&pref)tries.push(pref+u);tries.push(u);if((u.startsWith('/api/')||u.startsWith('/auth/'))&&base&&base!==pref)tries.push(base+u);let out={success:false,msg:'uninitialized'};for(const t of tries){out=await parse(t);if(out.success||!String(out.msg||'').startsWith('non-json response'))break;}return out;}catch(e){return{success:false,msg:e?.message||'network error'}}}

// 登录逻辑（保留原有功能）
async function doLogin(){
  const r=await api('/auth/login',{method:'POST',body:JSON.stringify({username:lu.value,password:lp.value})});
  if(!r.success){le.textContent=r.msg||'登录失败';return;}
  API_PREFIX=normPrefix(r.panelPath||'');
  localStorage.sessionToken=r.token;forceReset=!!r.mustReset;login.style.display='none';app.style.display='block';init();
  if(forceReset){switchTab('settings');forceResetTip.style.display='block';notify('首次登录必须先修改密码','err');}
}

// 退出登录
function logout(){localStorage.removeItem('sessionToken');location.reload();}

// 切换标签页
function switchTab(t){const main=t==='main',settings=t==='settings',xray=t==='xray';tabMain.style.display=main?'':'none';tabSettings.style.display=settings?'':'none';tabXray.style.display=xray?'':'none';$('tabMainBtn').className=main?'on':'';$('tabSettingsBtn').className=settings?'on':'';$('tabXrayBtn').className=xray?'on':'';}

// 面板设置相关（保留原有逻辑）
async function loadPanelSettings(){const r=await api('/api/panel/settings');if(!r.success)return;setUser.value=r.obj.username||'';setPath.value=r.obj.panelPath||'/';if(r.obj.forceResetPassword){forceReset=true;forceResetTip.style.display='block';}}
async function savePanelUsername(){const u=(setUser.value||'').trim();if(!u)return notify('用户名不能为空','err');const r=await api('/api/panel/settings',{method:'POST',body:JSON.stringify({username:u})});notify(r.success?'用户名已保存':(r.msg||'保存失败'),r.success?'ok':'err');}
async function savePanelPath(){const p=(setPath.value||'').trim()||'/';const r=await api('/api/panel/settings',{method:'POST',body:JSON.stringify({panelPath:p})});notify(r.success?'路径已保存（重启后生效）':(r.msg||'保存失败'),r.success?'ok':'err');}
async function changePanelPassword(){const np=(setNewPass.value||'').trim();if(np.length<6)return notify('新密码至少6位','err');const r=await api('/api/panel/change-password',{method:'POST',body:JSON.stringify({oldPassword:setOldPass.value,newPassword:np})});if(!r.success)return notify(r.msg||'修改失败','err');forceReset=false;forceResetTip.style.display='none';setOldPass.value='';setNewPass.value='';notify('密码已更新');}

// 数据格式化（保留原有逻辑）
function bytes(n){n=Number(n||0);if(n<1024)return n+'B';if(n<1048576)return(n/1024).toFixed(1)+'KB';if(n<1073741824)return(n/1048576).toFixed(1)+'MB';return(n/1073741824).toFixed(2)+'GB';}
function showLoadingRows(){
  if(!list) return;
  list.innerHTML='<div class="card">节点加载中…</div><div class="card">节点加载中…</div>';
}
function warmRenderFromCache(){
  try{
    const raw=localStorage.getItem('sui_inbounds_cache')||'';
    if(!raw) return;
    const cached=JSON.parse(raw);
    if(Array.isArray(cached) && cached.length){
      all=cached;
      render();
    }
  }catch{}
}

// 加载节点数据（保留原有逻辑）
async function loadData(){if(!all.length&&!forwards.length)showLoadingRows();const [d,f]=await Promise.all([api('/api/inbounds'),api('/api/forwards')]);if(!d.success){if((d.msg||'').includes('unauthorized')){localStorage.removeItem('sessionToken');app.style.display='none';login.style.display='block';}if(d.code==='RESET_REQUIRED'){forceReset=true;switchTab('settings');forceResetTip.style.display='block';}list.innerHTML='<div class="card">加载失败：'+(d.msg||'未授权')+'</div>';return;}all=d.obj||[];forwards=f.success?(f.obj||[]):[];try{localStorage.setItem('sui_inbounds_cache',JSON.stringify(all.slice(0,120)));}catch{}render();}
function upsertById(arr,item){const i=arr.findIndex(x=>x.id===item.id);if(i>=0)arr[i]=item;else arr.unshift(item)}
function removeById(arr,id){const i=arr.findIndex(x=>x.id===id);if(i>=0)arr.splice(i,1)}

// 渲染节点列表（保留原有逻辑，仅优化样式文字）
function render(){const qv=(q.value||'').toLowerCase();list.innerHTML='';const rows=all.filter(x=>`${x.remark||''} ${x.port} ${x.protocol}`.toLowerCase().includes(qv));const frows=(forwards||[]).filter(x=>`${x.remark||''} ${x.listenPort} ${x.protocol} ${x.targetHost}`.toLowerCase().includes(qv));if(!rows.length&&!frows.length){list.innerHTML='<div class="card">暂无节点</div>';return;}for(const i of rows){const el=document.createElement('div');el.className='card';el.innerHTML=`<div class='row' style='justify-content:space-between'><div class='row'><b>【#${i.id}】${i.remark||''}</b><span class='badge'>${i.protocol}</span><span class='badge'>端口:${i.port}</span><span class='badge ${i.enable?'status-ok':'status-bad'}'>${i.enable?'启用':'停用'}</span></div><div class='traffic-stat'>下行：${bytes(i.down)} ｜ 上行：${bytes(i.up||0)}</div></div><div class='row'><button onclick='toggle(${i.id})'><i class="fa fa-toggle-on"></i> 开关</button><button onclick='openEdit(${i.id})'><i class="fa fa-pencil"></i> 编辑</button><button onclick='copyLink(${i.id})'><i class="fa fa-copy"></i> 复制链接</button><button onclick='showQR(${i.id})'><i class="fa fa-qrcode"></i> 二维码</button><button class='danger' onclick='delN(${i.id})'><i class="fa fa-trash"></i> 删除</button></div>`;list.appendChild(el)}for(const f of frows){const el=document.createElement('div');el.className='card';el.innerHTML=`<div class='row' style='justify-content:space-between'><div class='row'><b>【F#${f.id}】${f.remark||'port-forward'}</b><span class='badge'>forward/${f.protocol}</span><span class='badge'>监听:${f.listenPort}</span><span class='badge'>目标:${f.targetHost}:${f.targetPort}</span><span class='badge ${f.enabled?'status-ok':'status-bad'}'>${f.enabled?'启用':'停用'}</span></div><div class='muted'>端口转发</div></div><div class='row'><button onclick='toggleForward(${f.id})'><i class="fa fa-toggle-on"></i> 开关</button><button onclick='openEditForward(${f.id})'><i class="fa fa-pencil"></i> 编辑</button><button class='danger' onclick='delForward(${f.id})'><i class="fa fa-trash"></i> 删除</button></div>`;list.appendChild(el)}}

// 节点操作相关（保留原有逻辑）
async function toggle(id){const r=await api('/api/inbounds/'+id+'/toggle',{method:'POST',body:'{}'});if(!r.success)return notify(r.msg||'切换失败','err');if(r.obj)upsertById(all,r.obj);else{const n=all.find(x=>x.id===id);if(n)n.enable=!n.enable;}render()}
async function delN(id){const r=await api('/api/inbounds/'+id,{method:'DELETE'});if(!r.success)return notify(r.msg||'删除失败','err');removeById(all,id);render();notify('节点已删除')}
async function delForward(id){const r=await api('/api/forwards/'+id,{method:'DELETE'});if(!r.success)return notify(r.msg||'删除失败','err');removeById(forwards,id);render();notify('端口转发已删除')}
async function toggleForward(id){const r=await api('/api/forwards/'+id+'/toggle',{method:'POST',body:'{}'});if(!r.success)return notify(r.msg||'切换失败','err');if(r.obj)upsertById(forwards,r.obj);else{const n=forwards.find(x=>x.id===id);if(n)n.enabled=!n.enabled;}render()}
async function copyLink(id){const r=await api('/api/inbounds/'+id+'/links');if(!r.success||!r.obj?.length)return notify('暂无可用链接','err');await navigator.clipboard.writeText(r.obj[0]);notify('链接已复制到剪贴板')}
async function showQR(id){const r=await api('/api/inbounds/'+id+'/qr');if(!r.success)return notify(r.msg||'生成二维码失败','err');qrImg.src=r.obj.qrDataUrl||r.obj.qrUrl||'';qrLink.value=r.obj.link||'';qrModal.classList.add('show')}

// 表单显隐控制（保留原有逻辑）
function setVis(el,show){el.style.display=show?'':'none'}

function ensureProxyAuthDefaults(){
  const isProxy=(f_protocol.value==='socks'||f_protocol.value==='http');
  if(!isProxy) return;
  if(!fAuthEnabled.checked) return;
  if(!fUser.value) fUser.value='user'+(f_port.value||'');
  if(!f_password.value) f_password.value='pass'+Math.random().toString(36).slice(2,10);
}
function tune(){const p=f_protocol.value,n=f_network.value;const isForward=p==='forward';const isProxyInbound=(p==='socks'||p==='http');const isReality=(!isForward&&!isProxyInbound&&f_security.value==='reality');if(p==='shadowsocks'||isForward||isProxyInbound){f_security.value='none';f_security.disabled=true;}else{f_security.disabled=false;}f_network.disabled=isForward||isProxyInbound;if(isProxyInbound)f_network.value='tcp';const s=f_security.value;const chainOn=fChainEnabled.value==='1';const chainType=fChainType.value;const sh={uuid:(p==='vless'||p==='vmess'),user:(isProxyInbound&&fAuthEnabled.checked),userAuth:isProxyInbound,password:(p==='trojan'||p==='shadowsocks'||(isProxyInbound&&fAuthEnabled.checked)),method:(p==='shadowsocks'),flow:(p==='vless'),ws:(!isForward&&!isProxyInbound&&n==='ws'),tls:(!isForward&&!isProxyInbound&&(s==='tls'||s==='reality')),reality:(!isForward&&!isProxyInbound&&s==='reality'),forward:isForward,chain:chainOn,chainAuth:chainOn&&(chainType==='socks5'||chainType==='http'),chainReality:chainOn&&chainType==='reality',chainSS:chainOn&&chainType==='shadowsocks',realityTools:isReality};document.querySelectorAll('[data-group]').forEach(el=>setVis(el,!!(sh[el.dataset.group] ?? sh[(el.dataset.group||"").replace("-","_")])));if(isProxyInbound){if(!fAuthEnabled.checked){fUser.value='';f_password.value='';}else ensureProxyAuthDefaults();}if(isReality&&(!f_privateKey.value||!f_shortId.value)){genReality();}}

// 工具函数（保留原有逻辑）
function genUUID(){f_uuid.value=(crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx').replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
function randSni(){const s=sniPool[Math.floor(Math.random()*sniPool.length)];f_sni.value=s;if(f_security.value==='reality')f_realityDest.value=s+':443'}
let __realityGenBusy=false;async function genReality(){if(__realityGenBusy)return;__realityGenBusy=true;try{const r=await api('/api/system/xray/reality-gen');if(!r.success)return notify(r.msg||'生成 Reality 密钥失败','err');f_privateKey.value=r.obj.privateKey||'';f_publicKey.value=r.obj.publicKey||'';f_shortId.value=r.obj.shortId||'';if(!f_sni.value)randSni();if(!f_uuid.value)genUUID();if(!f_flow.value)f_flow.value='xtls-rprx-vision';notify('Reality 密钥已自动生成并填入下方框');}finally{__realityGenBusy=false;}}


function collectNodeFormDraft(){
  return {
    remark:f_remark.value,port:f_port.value,protocol:f_protocol.value,forwardProtocol:fForwardProtocol.value,forwardTargetHost:fForwardTargetHost.value,forwardTargetPort:fForwardTargetPort.value,
    network:f_network.value,security:f_security.value,email:f_email.value,user:fUser.value,authEnabled:!!fAuthEnabled.checked,
    chainEnabled:fChainEnabled.value,chainType:fChainType.value,chainDomain:fChainDomain.value,chainEnhance:fChainEnhance.value,chainUdp443Policy:fChainUdp443Policy.value,
    chainHost:fChainHost.value,chainPort:fChainPort.value,chainUser:fChainUser.value,chainPass:fChainPass.value,chainUUID:fChainUUID.value,chainServerName:fChainServerName.value,
    chainPublicKey:fChainPublicKey.value,chainShortId:fChainShortId.value,chainFlow:fChainFlow.value,chainSSMethod:fChainSSMethod.value,chainSSPassword:fChainSSPassword.value,
    uuid:f_uuid.value,password:f_password.value,method:f_method.value,flow:f_flow.value,path:f_path.value,host:f_host.value,sni:f_sni.value,realityDest:f_realityDest.value,
    shortId:f_shortId.value,privateKey:f_privateKey.value,publicKey:f_publicKey.value
  };
}
function applyNodeFormDraft(d){
  if(!d) return;
  f_remark.value=d.remark||'';f_port.value=d.port||'';f_protocol.value=d.protocol||'vless';
  fForwardProtocol.value=d.forwardProtocol||'tcp';fForwardTargetHost.value=d.forwardTargetHost||'';fForwardTargetPort.value=d.forwardTargetPort||'';
  f_network.value=d.network||'tcp';f_security.value=d.security||'none';f_email.value=d.email||'';fUser.value=d.user||'';fAuthEnabled.checked=!!d.authEnabled;
  fChainEnabled.value=d.chainEnabled||'0';fChainType.value=d.chainType||'socks5';fChainDomain.value=d.chainDomain||'';fChainEnhance.value=d.chainEnhance||'1';fChainUdp443Policy.value=d.chainUdp443Policy||'block';
  fChainHost.value=d.chainHost||'';fChainPort.value=d.chainPort||'';fChainUser.value=d.chainUser||'';fChainPass.value=d.chainPass||'';fChainUUID.value=d.chainUUID||'';fChainServerName.value=d.chainServerName||'';
  fChainPublicKey.value=d.chainPublicKey||'';fChainShortId.value=d.chainShortId||'';fChainFlow.value=d.chainFlow||'';fChainSSMethod.value=d.chainSSMethod||'aes-128-gcm';fChainSSPassword.value=d.chainSSPassword||'';
  f_uuid.value=d.uuid||'';f_password.value=d.password||'';f_method.value=d.method||'aes-128-gcm';f_flow.value=d.flow||'';f_path.value=d.path||'/';f_host.value=d.host||'';f_sni.value=d.sni||'';f_realityDest.value=d.realityDest||'';
  f_shortId.value=d.shortId||'';f_privateKey.value=d.privateKey||'';f_publicKey.value=d.publicKey||'';
}
function clearNodeDraft(){ try{localStorage.removeItem(NODE_DRAFT_KEY)}catch{} }
function saveNodeDraft(){ try{localStorage.setItem(NODE_DRAFT_KEY, JSON.stringify(collectNodeFormDraft()))}catch{} }
function loadNodeDraft(){ try{const x=localStorage.getItem(NODE_DRAFT_KEY)||''; return x?JSON.parse(x):null}catch{return null} }
function resetNodeFormDefaults(){
  fForwardProtocol.value='tcp';fForwardTargetHost.value='';fForwardTargetPort.value='';
  fChainEnabled.value='0';fChainType.value='socks5';fChainDomain.value='';fChainEnhance.value='1';fChainUdp443Policy.value='block';
  fChainHost.value='';fChainPort.value='';fChainUser.value='';fChainPass.value='';fChainUUID.value='';fChainServerName.value='';fChainPublicKey.value='';fChainShortId.value='';fChainFlow.value='';fChainSSMethod.value='aes-128-gcm';fChainSSPassword.value='';
  fUser.value='';fAuthEnabled.checked=false;f_uuid.value='';f_password.value='';f_privateKey.value='';f_publicKey.value='';f_shortId.value='';
  f_remark.value='';f_email.value='';f_protocol.value='vless';f_network.value='tcp';f_security.value='none';f_method.value='aes-128-gcm';f_flow.value='';f_path.value='/';f_host.value='';f_sni.value='';f_realityDest.value='';
}

// 新增/编辑节点（保留原有逻辑）
async function openAdd(){editId=null;editForwardId=null;mt.innerHTML='<i class="fa fa-plus-circle"></i> 新增节点';const p=await api('/api/inbounds/next-port');resetNodeFormDefaults();if(p.success)f_port.value=p.obj;const d=loadNodeDraft();if(d)applyNodeFormDraft(d);tune();modal.classList.add('show')}
function fill(n){if(n.protocol==='forward'){f_remark.value=n.remark||'';f_port.value=n.listenPort||'';f_protocol.value='forward';fForwardProtocol.value=n.protocol2||n.forwardProtocol||n.protocolMode||n.protocol||'tcp';fForwardTargetHost.value=n.targetHost||'';fForwardTargetPort.value=n.targetPort||'';tune();return;}const st=JSON.parse(n.settings||'{}'),ss=JSON.parse(n.streamSettings||'{}'),c=(st.clients||[])[0]||{},acc=(st.accounts||[])[0]||{};const ch=n.chain||{};f_remark.value=n.remark||'';f_port.value=n.port||'';f_protocol.value=n.protocol||'vless';f_network.value=ss.network||'tcp';f_security.value=ss.security||'none';f_email.value=c.email||'';fUser.value=(n.protocol==='socks'||n.protocol==='http')?(acc.user||''):'';fAuthEnabled.checked=!!fUser.value;f_uuid.value=c.id||'';f_password.value=(n.protocol==='socks'||n.protocol==='http')?(acc.pass||''):(c.password||'');f_method.value=c.method||'aes-128-gcm';f_flow.value=c.flow||'';f_path.value=ss.wsSettings?.path||'/';f_host.value=ss.wsSettings?.headers?.Host||'';f_sni.value=ss.tlsSettings?.serverName||ss.realitySettings?.serverNames?.[0]||'';f_realityDest.value=ss.realitySettings?.dest||'';f_shortId.value=(ss.realitySettings?.shortIds||[])[0]||'';f_privateKey.value=ss.realitySettings?.privateKey||'';f_publicKey.value='';fChainEnabled.value=ch.enabled?'1':'0';fChainType.value=ch.type||'socks5';fChainDomain.value=ch.domainFilter||'';fChainEnhance.value=ch.enhanceDomainRouting===false?'0':'1';fChainUdp443Policy.value=ch.udp443Policy||'block';fChainHost.value=ch.host||'';fChainPort.value=ch.port||'';fChainUser.value=ch.user||'';fChainPass.value=ch.pass||'';fChainUUID.value=ch.uuid||'';fChainServerName.value=ch.serverName||'';fChainPublicKey.value=ch.publicKey||'';fChainShortId.value=ch.shortId||'';fChainFlow.value=ch.flow||'';fChainSSMethod.value=ch.method||'aes-128-gcm';fChainSSPassword.value=ch.password||'';tune()}
async function openEdit(id){const n=all.find(x=>x.id===id);if(!n)return;editId=id;editForwardId=null;mt.innerHTML='<i class="fa fa-pencil"></i> 编辑节点';fill(n);modal.classList.add('show')}
async function openEditForward(id){const n=(forwards||[]).find(x=>x.id===id);if(!n)return;editId=null;editForwardId=id;mt.innerHTML='<i class="fa fa-pencil"></i> 编辑端口转发';fill({...n,protocol:'forward',protocol2:n.protocol});modal.classList.add('show');}
function closeM(){if(!editId&&!editForwardId){const hasAny=Object.values(collectNodeFormDraft()).some(v=>String(v||'').trim()!==''&&String(v)!=='0');if(hasAny){if(confirm('保存本次新增节点草稿？\n确定=保存，下次继续填写\n取消=不保存并重置')) saveNodeDraft(); else clearNodeDraft();}}modal.classList.remove('show')}

// 提交节点（保留原有逻辑）
async function submitAdd(){const proto=f_protocol.value;if(proto==='forward'){const listenPort=Number(f_port.value||0),targetHost=(fForwardTargetHost.value||'').trim(),targetPort=Number(fForwardTargetPort.value||0),protocol=(fForwardProtocol.value||'tcp');if(!listenPort||!targetHost||!targetPort)return notify('请填写监听端口/目标IP/目标端口','err');const apiUrl=editForwardId?('/api/forwards/'+editForwardId):'/api/forwards';const apiMethod=editForwardId?'PUT':'POST';const fr=await api(apiUrl,{method:apiMethod,body:JSON.stringify({listenPort,targetHost,targetPort,protocol,remark:(f_remark.value||'')})});if(!fr.success)return notify(fr.msg||'端口转发保存失败','err');if(fr.obj)upsertById(forwards,fr.obj);closeM();render();notify(protocol==='both'?'TCP+UDP 端口转发保存成功（单条）':'端口转发保存成功');return;}const chainEnabled=fChainEnabled.value==='1';const chain={enabled:chainEnabled,type:fChainType.value,host:(fChainHost.value||'').trim(),port:Number(fChainPort.value||0),domainFilter:(fChainDomain.value||'').trim(),enhanceDomainRouting:fChainEnhance.value==='1',udp443Policy:fChainUdp443Policy.value||'block',user:(fChainUser.value||'').trim(),pass:fChainPass.value||'',uuid:(fChainUUID.value||'').trim(),serverName:(fChainServerName.value||'').trim(),publicKey:(fChainPublicKey.value||'').trim(),shortId:(fChainShortId.value||'').trim(),flow:(fChainFlow.value||'').trim(),method:(fChainSSMethod.value||'').trim()||'aes-128-gcm',password:fChainSSPassword.value||''};if(chainEnabled&&(!chain.host||!chain.port))return notify('已开启链式代理，请填写下游 host/port','err');const proxyAuthOn=(proto==='socks'||proto==='http')?fAuthEnabled.checked:true;const proxyUser=proxyAuthOn?fUser.value:'';const proxyPass=proxyAuthOn?f_password.value:'';const b={remark:f_remark.value,port:f_port.value,protocol:proto,network:f_network.value,security:f_security.value,email:f_email.value,user:proxyUser,uuid:f_uuid.value,password:(proto==='socks'||proto==='http')?proxyPass:f_password.value,method:f_method.value,flow:f_flow.value,path:f_path.value,host:f_host.value,sni:f_sni.value,realityDest:f_realityDest.value,shortId:f_shortId.value,privateKey:f_privateKey.value,chain};const url=editId?('/api/inbounds/'+editId+'/full'):'/api/inbounds/add';const m=editId?'PUT':'POST';const r=await api(url,{method:m,body:JSON.stringify(b)});if(!r.success)return notify(r.msg||'操作失败','err');if(r.obj)upsertById(all,r.obj);clearNodeDraft();closeM();render();notify('节点保存成功')}

// 一键 Reality（保留原有逻辑）
function randomNodeName(){const a=['sunny','lucky','silver','gentle','swift','quiet','stellar','autumn','velvet','amber'];const b=['bridge','garden','harbor','forest','island','comet','breeze','valley','summit','oasis'];return `${a[Math.floor(Math.random()*a.length)]}-${b[Math.floor(Math.random()*b.length)]}`;}
async function quickReality(){const def=randomNodeName();const finalName=def;const sni=sniPool[Math.floor(Math.random()*sniPool.length)];const r=await api('/api/inbounds/add-reality-quick',{method:'POST',body:JSON.stringify({remark:finalName,sni})});if(!r.success)return notify(r.msg||'创建一键 Reality失败','err');if(r.obj)upsertById(all,r.obj);render();notify('节点新建成功')}
async function restartPanel(){const r=await api('/api/system/restart-panel',{method:'POST',body:'{}'});if(!r.success)return notify(r.msg||'重启面板失败','err');notify('面板已重启');setTimeout(()=>location.reload(),900)}
async function restartXray(){const r=await api('/api/system/restart-xray',{method:'POST',body:'{}'});if(!r.success)return notify(r.msg||'重启 Xray 失败','err');notify('Xray 已重启');await Promise.all([loadCur(),loadStatus()])}
async function resetTrafficStats(){if(!confirm('确认清空当前所有节点流量统计？'))return;const r=await api('/api/system/traffic/reset',{method:'POST',body:'{}'});if(!r.success)return notify(r.msg||'清空失败','err');notify('流量统计已清空');await loadData();}

async function loadXrayConfig(){const r=await api('/api/system/xray/config');if(!r.success)return notify(r.msg||'读取配置失败','err');xrayConfigText.value=r.obj?.content||''}
async function saveXrayConfig(){const content=(xrayConfigText.value||'').trim();if(!content)return notify('配置内容不能为空','err');const r=await api('/api/system/xray/config',{method:'POST',body:JSON.stringify({content})});if(!r.success)return notify(r.msg||'保存配置失败','err');notify(r.msg||'配置保存成功')}
async function testChainConnectivity(){if(fChainEnabled.value!=='1')return notify('请先开启链式代理','err');const host=(fChainHost.value||'').trim();const port=Number(fChainPort.value||0);if(!host||!port)return notify('请先填写下游 host/port','err');const r=await api('/api/system/chain/test',{method:'POST',body:JSON.stringify({host,port})});notify(r.success?'下游连通性正常':(r.msg||'连通性失败'),r.success?'ok':'err')}

// 加载引擎信息（保留原有逻辑）
async function loadCur(){const r=await api('/api/system/xray/version-current');if(r.success){cv.textContent=`📜 当前 Xray: ${(r.obj.binary||'-')} / ${(r.obj.panel||'-')}`;return;}cv.textContent='📜 当前 Xray: 获取失败'}

// 加载状态（保留原有逻辑）
let __lastStatus='';
let __statusFailCount=0;
let __lastGoodStatus=null;
async function loadStatus(){const r=await api('/api/system/status');if(!r.success){__statusFailCount++;if((r.msg||'').includes('unauthorized')){sp.textContent='面板:未登录';sx.textContent='Xray:未登录';si.textContent='节点:-';sp.className='badge status-bad';sx.className='badge status-bad';return;}if(__lastGoodStatus&&__statusFailCount<3){sp.textContent=`面板:${__lastGoodStatus.panelTxt}（缓存）`;sx.textContent=`Xray:${__lastGoodStatus.xrayTxt}（缓存）`;si.textContent=`节点:${__lastGoodStatus.nodeTxt}（缓存）`;sp.className='badge status-ok';sx.className='badge status-ok';return;}sp.textContent='面板:检测中';sx.textContent='Xray:检测中';si.textContent='节点:检测中';sp.className='badge';sx.className='badge';return;}__statusFailCount=0;const o=r.obj||{};const ok=v=>v==='active';const ptxt=ok(o.panel?.active)?'正常':'不正常';const xtxt=ok(o.xray?.active)?'正常':'不正常';const nodeTxt=`${(o.inboundsEnabled??'-')}/${(o.inboundsTotal??'-')}`;const xrayTxt=`${xtxt}${o.xrayVersion?(' · '+o.xrayVersion):''}`;const next=`${ptxt}|${xrayTxt}|${nodeTxt}`;__lastGoodStatus={panelTxt:ptxt,xrayTxt,nodeTxt};if(next===__lastStatus)return;__lastStatus=next;sp.textContent=`面板:${ptxt}`;sp.className='badge '+(ok(o.panel?.active)?'status-ok':'status-bad');sx.textContent=`Xray:${xrayTxt}`;sx.className='badge '+(ok(o.xray?.active)?'status-ok':'status-bad');si.textContent=`节点:${nodeTxt}`}


async function loadXrayVersions(){
  const [cur,vers]=await Promise.all([api('/api/system/xray/version-current'),api('/api/system/xray/versions')]);
  const curv = cur.success ? String(cur.obj.binary||'') : '';
  if(cur.success){
    xvNow.textContent=`当前 Xray: ${(cur.obj.binary||'-')} / ${(cur.obj.panel||'self-hosted')}`;
  }
  xvSel.innerHTML='';
  if(vers.success&&Array.isArray(vers.obj)&&vers.obj.length){
    for(const v of vers.obj){
      const o=document.createElement('option');
      o.value=v;
      o.textContent=v;
      if(curv && (v===curv || ('v'+v)===curv || v===('v'+curv))) o.selected=true;
      xvSel.appendChild(o)
    }
    if(xvHint) xvHint.textContent='提示：下拉选择版本后点“立即安装所选版本”，会自动重启 Xray 服务。';
  }else{
    const o=document.createElement('option');o.value='';o.textContent='(版本列表获取失败)';xvSel.appendChild(o);
    if(xvHint) xvHint.textContent='提示：版本列表获取失败（可能是网络原因），请稍后重试。';
  }
}
async function switchXrayVersion(){
  let v=(xvSel.value||'').trim();
  if(!v) return notify('请先在下拉框选择版本','err');
  if(!v.startsWith('v')) v='v'+v;
  const r=await api('/api/system/xray/switch',{method:'POST',body:JSON.stringify({version:v})});
  if(!r.success) return notify(r.msg||'安装/切换失败','err');
  notify('已开始安装并切换，正在刷新状态');
  await Promise.all([loadCur(),loadStatus(),loadXrayVersions()]);
}


let __statusTimer=null;
let __dataTimer=null;
function startRefreshLoops(){
  stopRefreshLoops();
  const statusTick=async()=>{await loadStatus();__statusTimer=setTimeout(statusTick, document.hidden?30000:12000)};
  const dataTick=async()=>{if(!forceReset && !modal.classList.contains('show') && !qrModal.classList.contains('show')) await loadData();__dataTimer=setTimeout(dataTick, document.hidden?30000:10000)};
  __statusTimer=setTimeout(statusTick,500);
  __dataTimer=setTimeout(dataTick,1000);
}
function stopRefreshLoops(){
  if(__statusTimer){clearTimeout(__statusTimer);__statusTimer=null;}
  if(__dataTimer){clearTimeout(__dataTimer);__dataTimer=null;}
}

document.addEventListener('visibilitychange',()=>{
  if(document.hidden) return;
  loadStatus();
  if(!forceReset) loadData();
});

// 初始化（保留原有逻辑）
async function init(){let __qTimer=null;q.oninput=()=>{clearTimeout(__qTimer);__qTimer=setTimeout(render,120)};f_protocol.onchange=()=>{if((f_protocol.value==='socks'||f_protocol.value==='http')&&fAuthEnabled.checked)ensureProxyAuthDefaults();tune()};f_network.onchange=tune;f_security.onchange=tune;fAuthEnabled.onchange=()=>{if(fAuthEnabled.checked)ensureProxyAuthDefaults();tune()};fChainEnabled.onchange=tune;fChainType.onchange=tune;fChainEnhance.onchange=tune;fChainUdp443Policy.onchange=tune;switchTab('main');
  await Promise.all([loadPanelSettings(),loadCur(),loadStatus()]);
  if(!forceReset){
    warmRenderFromCache();
    loadData();
  }
  // 版本列表可能受外网影响较慢，改为后台加载，避免拖慢登录后节点显示
  loadXrayVersions();
  startRefreshLoops();
}

// 页面启动逻辑（保留原有逻辑）
(async()=>{if(localStorage.sessionToken){const me=await api('/auth/me');if(me.success){API_PREFIX=normPrefix(me.panelPath||'');forceReset=!!me.mustReset;login.style.display='none';app.style.display='block';init();if(forceReset){switchTab('settings');forceResetTip.style.display='block';}return;}localStorage.removeItem('sessionToken');}login.style.display='block';app.style.display='none';})();
</script>
</body>
</html>
