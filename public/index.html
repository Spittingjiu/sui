<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SUI Panel</title>
  <style>
    :root{
      --bg:#0b1020;--bg2:#121933;--card:#151f3dcc;--line:#6f85ff55;--txt:#eaf0ff;
      --pri:#6f7dff;--ok:#3de6b4;--bad:#ff5d8f;--muted:#9aa6d1;
    }
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 500px at -20% -20%,#5c5dff40,transparent 65%),radial-gradient(900px 480px at 120% -10%,#00d3ff30,transparent 62%),linear-gradient(145deg,var(--bg),#111834 45%,#131133);color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;transition:background .45s ease,color .3s ease}
    .wrap{max-width:1120px;margin:auto;padding:16px;animation:fadeIn .35s ease}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 0;backdrop-filter:blur(8px);box-shadow:0 8px 24px #0006;transition:transform .2s ease,border-color .25s ease,box-shadow .25s ease,opacity .2s ease}
    .card:hover{transform:translateY(-1px);border-color:#8ca0ff88;box-shadow:0 12px 30px #0007}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    input,select,textarea,button{background:#111a3a;color:#fff;border:1px solid #5c74d9;border-radius:10px;padding:9px 10px;transition:border-color .2s ease,box-shadow .2s ease,transform .15s ease,filter .2s ease}
    button{background:linear-gradient(90deg,#5873ff,#7f62ff);border:0;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    .danger{background:linear-gradient(90deg,#ff557f,#ff4dbd)}
    .badge{padding:3px 9px;border-radius:999px;border:1px solid #6f85ff66;background:#0f1733}
    .status-ok{border-color:var(--ok)!important}.status-bad{border-color:var(--bad)!important}
    .muted{color:var(--muted)}
    .tabs button{opacity:.75}.tabs .on{opacity:1}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .m{position:fixed;inset:0;background:#050b1ccc;display:none;align-items:center;justify-content:center;transition:opacity .2s ease}
    .m.show{display:flex;animation:fadeIn .18s ease}.box{width:min(980px,95vw);max-height:90vh;overflow:auto;background:#111a35f0;border:1px solid var(--line);border-radius:16px;padding:14px;animation:popIn .2s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{from{opacity:.35;transform:translateY(6px) scale(.99)}to{opacity:1;transform:translateY(0) scale(1)}}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div id="login" class="wrap">
  <div class="card" style="max-width:420px;margin:12vh auto">
    <h2 style="margin:0 0 8px">ğŸ” SUI Panel ç™»å½•</h2>
    <div class="muted" style="margin-bottom:10px">ç®€æ´ã€ç¨³å®šã€å¯è¿ç»´</div>
    <input id="lu" placeholder="ç”¨æˆ·å" style="width:100%" />
    <input id="lp" type="password" placeholder="å¯†ç " style="width:100%;margin-top:8px" />
    <button style="width:100%;margin-top:10px" onclick="doLogin()">ç™»å½•</button>
    <div id="le" style="color:#ff9cb0;margin-top:8px"></div>
  </div>
</div>

<div id="app" class="wrap" style="display:none">
  <div class="card row tabs">
    <b>ğŸš€ SUI Panel</b>
    <button id="tabMainBtn" class="on" onclick="switchTab('main')">èŠ‚ç‚¹ç®¡ç†</button>
    <button id="tabSettingsBtn" onclick="switchTab('settings')">é¢æ¿è®¾ç½®</button>
    <span class="grow"></span>
    <button class="danger" onclick="logout()">é€€å‡º</button>
  </div>

  <div id="tab-main">
    <div class="card row">
      <input id="q" class="grow" placeholder="æœç´¢å¤‡æ³¨ / ç«¯å£ / åè®®" />
      <button onclick="loadData()">åˆ·æ–°</button>
      <button onclick="openAdd()">æ–°å¢</button>
      <button onclick="quickReality()">ä¸€é”® Reality</button>
      <span id="cv" class="badge">å½“å‰ Xray:-</span>
    </div>

    <div class="card row">
      <b>æœåŠ¡çŠ¶æ€</b>
      <span id="sp" class="badge">Panel:-</span>
      <span id="sx" class="badge">Xray:-</span>
      <span id="si" class="badge">Inbounds:-</span>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:8px"><b>ç«¯å£è½¬å‘</b><span class="muted">è¾“å…¥ç›®æ ‡IPå’Œç«¯å£åˆ›å»ºè½¬å‘</span></div>
      <div class="row">
        <input id="fw_listen" placeholder="ç›‘å¬ç«¯å£(å¦‚ 12345)" style="width:170px" />
        <select id="fw_protocol" style="width:100px"><option value="tcp">TCP</option><option value="udp">UDP</option></select>
        <input id="fw_target_host" placeholder="ç›®æ ‡IP/åŸŸå" style="width:220px" />
        <input id="fw_target_port" placeholder="ç›®æ ‡ç«¯å£" style="width:140px" />
        <input id="fw_remark" placeholder="å¤‡æ³¨(å¯é€‰)" class="grow" />
        <button onclick="addForward()">æ·»åŠ è½¬å‘</button>
      </div>
      <div id="fw_list" style="margin-top:10px"></div>
    </div>

    <div id="list"></div>
  </div>

  <div id="tab-settings" style="display:none">
    <div class="card">
      <div id="forceResetTip" style="display:none;color:#ffd6e3;margin-bottom:8px">é¦–æ¬¡ç™»å½•è¯·å…ˆä¿®æ”¹å¯†ç </div>
      <div class="grid">
        <div>
          <div class="muted">ç”¨æˆ·å</div>
          <input id="set_user" style="width:100%" />
          <button style="margin-top:8px;width:100%" onclick="savePanelUsername()">ä¿å­˜ç”¨æˆ·å</button>
        </div>
        <div>
          <div class="muted">é¢æ¿è·¯å¾„</div>
          <input id="set_path" placeholder="/" style="width:100%" />
          <button style="margin-top:8px;width:100%" onclick="savePanelPath()">ä¿å­˜è·¯å¾„</button>
        </div>
        <div>
          <div class="muted">ä¿®æ”¹å¯†ç </div>
          <input id="set_old_pass" type="password" placeholder="æ—§å¯†ç ï¼ˆé¦–æ¬¡å¯ç•™ç©ºï¼‰" style="width:100%" />
          <input id="set_new_pass" type="password" placeholder="æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" style="width:100%;margin-top:8px" />
          <button style="margin-top:8px;width:100%" onclick="changePanelPassword()">æ›´æ–°å¯†ç </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modal" class="m"><div class="box">
  <div class="row"><b id="mt">æ–°å¢èŠ‚ç‚¹</b><span class="grow"></span><button onclick="closeM()">å…³é—­</button></div>
  <div class="grid" style="margin-top:8px">
    <input id="f_remark" placeholder="å¤‡æ³¨" />
    <input id="f_port" placeholder="ç«¯å£" />
    <select id="f_protocol"><option>vless</option><option>vmess</option><option>trojan</option><option>shadowsocks</option></select>

    <select id="f_network"><option>tcp</option><option>ws</option></select>
    <select id="f_security"><option>none</option><option>tls</option><option>reality</option></select>
    <input id="f_email" placeholder="email(tag)" />

    <input id="f_uuid" placeholder="uuid" data-group="uuid" />
    <input id="f_password" placeholder="password" data-group="password" />
    <input id="f_method" placeholder="method" data-group="method" value="aes-128-gcm" />

    <input id="f_flow" placeholder="flow(å¦‚ xtls-rprx-vision)" data-group="flow" />
    <input id="f_path" placeholder="ws path" data-group="ws" value="/" />
    <input id="f_host" placeholder="ws host" data-group="ws" />

    <input id="f_sni" placeholder="sni" data-group="tls" />
    <input id="f_realityDest" placeholder="reality dest (å¦‚ addons.mozilla.org:443)" data-group="reality" />
    <input id="f_shortId" placeholder="shortId" data-group="reality" />

    <input id="f_privateKey" placeholder="privateKey" data-group="reality" />
    <input id="f_publicKey" placeholder="publicKey(å±•ç¤ºç”¨)" data-group="reality" />

    <label class="row" style="grid-column:1/-1"><input id="f_forward_enable" type="checkbox" style="width:auto" /> åŒæ—¶åˆ›å»ºç«¯å£è½¬å‘</label>
    <select id="f_forward_protocol" style="width:120px"><option value="tcp">TCP</option><option value="udp">UDP</option></select>
    <input id="f_forward_target_host" placeholder="è½¬å‘ç›®æ ‡IP/åŸŸå" />
    <input id="f_forward_target_port" placeholder="è½¬å‘ç›®æ ‡ç«¯å£" />
  </div>
  <div class="row" style="margin-top:10px">
    <button onclick="genUUID()">ç”Ÿæˆ UUID</button>
    <button onclick="randSni()">éšæœº SNI</button>
    <button onclick="genReality()">ç”Ÿæˆ Reality å¯†é’¥</button>
    <button onclick="applyNodeSpeedPreset()">æ¨èå‚æ•°</button>
    <span class="grow"></span>
    <button onclick="submitAdd()">ä¿å­˜</button>
  </div>
</div></div>

<div id="qrModal" class="m"><div class="box" style="max-width:420px">
  <div class="row"><b>äºŒç»´ç </b><span class="grow"></span><button onclick="qrModal.classList.remove('show')">å…³é—­</button></div>
  <img id="qrImg" style="max-width:320px;width:100%;background:#fff;padding:8px;border-radius:8px" />
  <textarea id="qrLink" style="width:100%;min-height:72px"></textarea>
  <button onclick="navigator.clipboard.writeText(qrLink.value)">å¤åˆ¶é“¾æ¥</button>
</div></div>

<script>
const $=id=>document.getElementById(id);
let all=[],editId=null,forceReset=false;
const sniPool=['addons.mozilla.org','www.icloud.com','www.lovelive-anime.jp','icloud.cdn-apple.com','swdist.apple.com','www.microsoft.com','www.apple.com','www.bing.com','www.amazon.com'];
const q=$('q'), list=$('list'), cv=$('cv'), mt=$('mt'), login=$('login'), app=$('app'), lu=$('lu'), lp=$('lp'), le=$('le');
const qrModal=$('qrModal'), qrImg=$('qrImg'), qrLink=$('qrLink'), sp=$('sp'), sx=$('sx'), si=$('si');
const fwList=$('fw_list'), fwListen=$('fw_listen'), fwProtocol=$('fw_protocol'), fwTargetHost=$('fw_target_host'), fwTargetPort=$('fw_target_port'), fwRemark=$('fw_remark');
const tabMain=$('tab-main'), tabSettings=$('tab-settings'), forceResetTip=$('forceResetTip');
const setUser=$('set_user'), setPath=$('set_path'), setOldPass=$('set_old_pass'), setNewPass=$('set_new_pass');
const fForwardEnable=$('f_forward_enable'), fForwardProtocol=$('f_forward_protocol'), fForwardTargetHost=$('f_forward_target_host'), fForwardTargetPort=$('f_forward_target_port');
let API_PREFIX='';

function hdr(){const t=localStorage.sessionToken||'';return t?{'Authorization':'Bearer '+t}:{}};
function panelBasePath(){const p=location.pathname||'/';if(p==='/'||p==='')return '';if(p.endsWith('/'))return p.slice(0,-1);if(/\.html?$/.test(p))return p.replace(/\/[^/]+$/,'');return p;}
function normPrefix(p){if(!p||p==='/'||p==='null'||p==='undefined')return '';return String(p).startsWith('/')?String(p).replace(/\/$/,''):'/'+String(p).replace(/\/$/,'');}
async function api(u,o={}){const parse=async(url)=>{const r=await fetch(url,{...o,headers:{'content-type':'application/json',...hdr(),...(o.headers||{})}});const txt=await r.text();let j={};try{j=txt?JSON.parse(txt):{};}catch{j={success:false,msg:'non-json response: '+(txt||'').slice(0,120)};}if(j.success===undefined)j.success=r.ok;return j;};try{const base=normPrefix(panelBasePath());const pref=normPrefix(API_PREFIX);const tries=[];if((u.startsWith('/api/')||u.startsWith('/auth/'))&&pref)tries.push(pref+u);tries.push(u);if((u.startsWith('/api/')||u.startsWith('/auth/'))&&base&&base!==pref)tries.push(base+u);let out={success:false,msg:'uninitialized'};for(const t of tries){out=await parse(t);if(out.success||!String(out.msg||'').startsWith('non-json response'))break;}return out;}catch(e){return{success:false,msg:e?.message||'network error'}}}

async function doLogin(){
  const r=await api('/auth/login',{method:'POST',body:JSON.stringify({username:lu.value,password:lp.value})});
  if(!r.success){le.textContent=r.msg||'ç™»å½•å¤±è´¥';return;}
  API_PREFIX=normPrefix(r.panelPath||'');
  localStorage.sessionToken=r.token;forceReset=!!r.mustReset;login.style.display='none';app.style.display='block';init();
  if(forceReset){switchTab('settings');forceResetTip.style.display='block';alert('é¦–æ¬¡ç™»å½•å¿…é¡»å…ˆä¿®æ”¹å¯†ç ');}
}
function logout(){localStorage.removeItem('sessionToken');location.reload();}
function switchTab(t){const main=t==='main';tabMain.style.display=main?'':'none';tabSettings.style.display=main?'none':'';$('tabMainBtn').className=main?'on':'';$('tabSettingsBtn').className=main?'':'on';}

async function loadPanelSettings(){const r=await api('/api/panel/settings');if(!r.success)return;setUser.value=r.obj.username||'';setPath.value=r.obj.panelPath||'/';if(r.obj.forceResetPassword){forceReset=true;forceResetTip.style.display='block';}}
async function savePanelUsername(){const u=(setUser.value||'').trim();if(!u)return alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');const r=await api('/api/panel/settings',{method:'POST',body:JSON.stringify({username:u})});alert(r.success?'ç”¨æˆ·åå·²ä¿å­˜':(r.msg||'ä¿å­˜å¤±è´¥'));}
async function savePanelPath(){const p=(setPath.value||'').trim()||'/';const r=await api('/api/panel/settings',{method:'POST',body:JSON.stringify({panelPath:p})});alert(r.success?'è·¯å¾„å·²ä¿å­˜ï¼ˆé‡å¯åç”Ÿæ•ˆï¼‰':(r.msg||'ä¿å­˜å¤±è´¥'));}
async function changePanelPassword(){const np=(setNewPass.value||'').trim();if(np.length<6)return alert('æ–°å¯†ç è‡³å°‘6ä½');const r=await api('/api/panel/change-password',{method:'POST',body:JSON.stringify({oldPassword:setOldPass.value,newPassword:np})});if(!r.success)return alert(r.msg||'ä¿®æ”¹å¤±è´¥');forceReset=false;forceResetTip.style.display='none';setOldPass.value='';setNewPass.value='';alert('å¯†ç å·²æ›´æ–°');}

function bytes(n){n=Number(n||0);if(n<1024)return n+'B';if(n<1048576)return(n/1024).toFixed(1)+'KB';if(n<1073741824)return(n/1048576).toFixed(1)+'MB';return(n/1073741824).toFixed(2)+'GB';}
async function loadData(){const d=await api('/api/inbounds');if(!d.success){if((d.msg||'').includes('unauthorized')){localStorage.removeItem('sessionToken');app.style.display='none';login.style.display='block';}if(d.code==='RESET_REQUIRED'){forceReset=true;switchTab('settings');forceResetTip.style.display='block';}list.innerHTML='<div class="card">åŠ è½½å¤±è´¥ï¼š'+(d.msg||'æœªæˆæƒ')+'</div>';return;}all=d.obj||[];render();}
function render(){const qv=(q.value||'').toLowerCase();list.innerHTML='';const rows=all.filter(x=>`${x.remark||''} ${x.port} ${x.protocol}`.toLowerCase().includes(qv));if(!rows.length){list.innerHTML='<div class="card">æš‚æ— èŠ‚ç‚¹</div>';return;}for(const i of rows){const el=document.createElement('div');el.className='card';el.innerHTML=`<div class='row' style='justify-content:space-between'><div class='row'><b>#${i.id} ${i.remark||''}</b><span class='badge'>${i.protocol}</span><span class='badge'>:${i.port}</span><span class='badge ${i.enable?'status-ok':'status-bad'}'>${i.enable?'å¯ç”¨':'åœç”¨'}</span></div><div class='muted'>â†“${bytes(i.down)} â†‘${bytes(i.up||0)}</div></div><div class='row'><button onclick='toggle(${i.id})'>å¼€å…³</button><button onclick='openEdit(${i.id})'>ç¼–è¾‘</button><button onclick='copyLink(${i.id})'>å¤åˆ¶é“¾æ¥</button><button onclick='showQR(${i.id})'>äºŒç»´ç </button><button class='danger' onclick='delN(${i.id})'>åˆ é™¤</button></div>`;list.appendChild(el)}}
async function toggle(id){await api('/api/inbounds/'+id+'/toggle',{method:'POST',body:'{}'});loadData()}
async function delN(id){if(!confirm('ç¡®è®¤åˆ é™¤?'))return;await api('/api/inbounds/'+id,{method:'DELETE'});loadData()}
async function copyLink(id){const r=await api('/api/inbounds/'+id+'/links');if(!r.success||!r.obj?.length)return alert('æš‚æ— ');await navigator.clipboard.writeText(r.obj[0]);alert('å·²å¤åˆ¶')}
async function showQR(id){const r=await api('/api/inbounds/'+id+'/qr');if(!r.success)return alert(r.msg||'å¤±è´¥');qrImg.src=r.obj.qrDataUrl||r.obj.qrUrl||'';qrLink.value=r.obj.link||'';qrModal.classList.add('show')}

function setVis(el,show){el.style.display=show?'':'none'}
function tune(){const p=f_protocol.value,n=f_network.value,s=f_security.value;const sh={uuid:(p==='vless'||p==='vmess'),password:(p==='trojan'||p==='shadowsocks'),method:(p==='shadowsocks'),flow:(p==='vless'),ws:(n==='ws'),tls:(s==='tls'||s==='reality'),reality:(s==='reality')};document.querySelectorAll('[data-group]').forEach(el=>setVis(el,!!sh[el.dataset.group]))}
function genUUID(){f_uuid.value=(crypto.randomUUID?crypto.randomUUID():'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx').replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
function randSni(){const s=sniPool[Math.floor(Math.random()*sniPool.length)];f_sni.value=s;if(f_security.value==='reality')f_realityDest.value=s+':443'}
async function genReality(){const r=await api('/api/system/xray/reality-gen');if(!r.success)return alert(r.msg||'å¤±è´¥');f_privateKey.value=r.obj.privateKey||'';f_publicKey.value=r.obj.publicKey||'';f_shortId.value=r.obj.shortId||'';if(!f_sni.value)randSni();if(!f_uuid.value)genUUID();if(!f_flow.value)f_flow.value='xtls-rprx-vision'}
async function openAdd(){editId=null;mt.textContent='æ–°å¢èŠ‚ç‚¹';modal.classList.add('show');const p=await api('/api/inbounds/next-port');if(p.success)f_port.value=p.obj;fForwardEnable.checked=false;fForwardProtocol.value='tcp';fForwardTargetHost.value='';fForwardTargetPort.value='';genUUID();tune()}
function fill(n){const st=JSON.parse(n.settings||'{}'),ss=JSON.parse(n.streamSettings||'{}'),c=(st.clients||[])[0]||{};f_remark.value=n.remark||'';f_port.value=n.port||'';f_protocol.value=n.protocol||'vless';f_network.value=ss.network||'tcp';f_security.value=ss.security||'none';f_email.value=c.email||'';f_uuid.value=c.id||'';f_password.value=c.password||'';f_method.value=c.method||'aes-128-gcm';f_flow.value=c.flow||'';f_path.value=ss.wsSettings?.path||'/';f_host.value=ss.wsSettings?.headers?.Host||'';f_sni.value=ss.tlsSettings?.serverName||ss.realitySettings?.serverNames?.[0]||'';f_realityDest.value=ss.realitySettings?.dest||'';f_shortId.value=(ss.realitySettings?.shortIds||[])[0]||'';f_privateKey.value=ss.realitySettings?.privateKey||'';f_publicKey.value='';tune()}
async function openEdit(id){const n=all.find(x=>x.id===id);if(!n)return;editId=id;mt.textContent='ç¼–è¾‘èŠ‚ç‚¹';modal.classList.add('show');fill(n)}
function closeM(){modal.classList.remove('show')}
async function submitAdd(){const b={remark:f_remark.value,port:f_port.value,protocol:f_protocol.value,network:f_network.value,security:f_security.value,email:f_email.value,uuid:f_uuid.value,password:f_password.value,method:f_method.value,flow:f_flow.value,path:f_path.value,host:f_host.value,sni:f_sni.value,realityDest:f_realityDest.value,shortId:f_shortId.value,privateKey:f_privateKey.value};const url=editId?('/api/inbounds/'+editId+'/full'):'/api/inbounds/add';const m=editId?'PUT':'POST';const r=await api(url,{method:m,body:JSON.stringify(b)});if(!r.success)return alert(r.msg||'å¤±è´¥');if(!editId&&fForwardEnable.checked){const targetHost=(fForwardTargetHost.value||'').trim(),targetPort=Number(fForwardTargetPort.value||0),listenPort=Number(f_port.value||0),protocol=fForwardProtocol.value||'tcp';if(!targetHost||!targetPort)return alert('èŠ‚ç‚¹å·²åˆ›å»ºï¼Œä½†è½¬å‘å¤±è´¥ï¼šè¯·å¡«å†™ç›®æ ‡IPå’Œç›®æ ‡ç«¯å£');const fr=await api('/api/forwards',{method:'POST',body:JSON.stringify({listenPort,targetHost,targetPort,protocol,remark:'node-'+(f_remark.value||listenPort)})});if(!fr.success)return alert('èŠ‚ç‚¹å·²åˆ›å»ºï¼Œä½†è½¬å‘å¤±è´¥ï¼š'+(fr.msg||'unknown'));}closeM();loadData();loadForwards()}
async function quickReality(){const remark=prompt('å¤‡æ³¨','reality-auto');if(remark===null)return;const r=await api('/api/inbounds/add-reality-quick',{method:'POST',body:JSON.stringify({remark})});if(!r.success)return alert(r.msg||'å¤±è´¥');loadData();alert('åˆ›å»ºæˆåŠŸ')}
function applyNodeSpeedPreset(){f_protocol.value='vless';f_network.value='tcp';f_security.value='reality';if(!f_flow.value)f_flow.value='xtls-rprx-vision';if(!f_sni.value)randSni();if(!f_realityDest.value&&f_sni.value)f_realityDest.value=f_sni.value+':443';if(!f_uuid.value)genUUID();tune();alert('å·²åº”ç”¨æ¨èå‚æ•°')}

async function loadCur(){const r=await api('/api/system/xray/version-current');if(r.success){cv.textContent='å½“å‰ Xray: '+((r.obj.binary||'-')+' / '+(r.obj.panel||'-'));return;}cv.textContent='å½“å‰ Xray: è·å–å¤±è´¥'}
async function loadStatus(){const r=await api('/api/system/status');if(!r.success){sp.textContent='Panel:err';sx.textContent='Xray:err';si.textContent='Inbounds:err';sp.title=sx.title=si.title=(r.msg||'status failed');return;}const o=r.obj||{};const ok=v=>v==='active';sp.textContent='Panel:'+((o.panel?.active)||'-');sp.className='badge '+(ok(o.panel?.active)?'status-ok':'status-bad');sx.textContent='Xray:'+((o.xray?.active)||'-')+(o.xrayVersion?(' Â· '+o.xrayVersion):'');sx.className='badge '+(ok(o.xray?.active)?'status-ok':'status-bad');si.textContent='Inbounds:'+(o.inboundsEnabled??'-')+'/'+(o.inboundsTotal??'-')}

async function loadForwards(){const r=await api('/api/forwards');if(!r.success){fwList.innerHTML='<div class="muted">åŠ è½½å¤±è´¥ï¼š'+(r.msg||'unknown')+'</div>';return;}const arr=r.obj||[];if(!arr.length){fwList.innerHTML='<div class="muted">æš‚æ— è½¬å‘è§„åˆ™</div>';return;}fwList.innerHTML='';for(const x of arr){const row=document.createElement('div');row.className='row';row.style.margin='6px 0';const on=x.active==='active';row.innerHTML=`<span class='badge'>#${x.id}</span><span class='badge'>${(x.protocol||'tcp').toUpperCase()}</span><span class='badge'>:${x.listenPort} â†’ ${x.targetHost}:${x.targetPort}</span><span class='badge ${on?'status-ok':'status-bad'}'>${x.active||'-'}</span><span class='muted'>${x.remark||''}</span><span class='grow'></span><button onclick='toggleForward(${x.id})'>${x.enabled?'åœç”¨':'å¯ç”¨'}</button><button class='danger' onclick='delForward(${x.id})'>åˆ é™¤</button>`;fwList.appendChild(row);}}
async function addForward(){const listenPort=Number(fwListen.value||0),targetPort=Number(fwTargetPort.value||0),targetHost=(fwTargetHost.value||'').trim(),protocol=(fwProtocol.value||'tcp'),remark=(fwRemark.value||'').trim();if(!listenPort||!targetHost||!targetPort)return alert('è¯·å¡«å†™ç›‘å¬ç«¯å£/ç›®æ ‡IP/ç›®æ ‡ç«¯å£');const r=await api('/api/forwards',{method:'POST',body:JSON.stringify({listenPort,targetHost,targetPort,protocol,remark})});if(!r.success)return alert(r.msg||'åˆ›å»ºå¤±è´¥');fwListen.value='';fwTargetHost.value='';fwTargetPort.value='';fwRemark.value='';loadForwards();}
async function toggleForward(id){const r=await api('/api/forwards/'+id+'/toggle',{method:'POST',body:'{}'});if(!r.success)return alert(r.msg||'æ“ä½œå¤±è´¥');loadForwards();}
async function delForward(id){if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è½¬å‘è§„åˆ™?'))return;const r=await api('/api/forwards/'+id,{method:'DELETE'});if(!r.success)return alert(r.msg||'åˆ é™¤å¤±è´¥');loadForwards();}

async function init(){q.oninput=render;f_protocol.onchange=tune;f_network.onchange=tune;f_security.onchange=tune;switchTab('main');await loadPanelSettings();await loadCur();await loadStatus();await loadForwards();if(!forceReset)await loadData();setInterval(loadStatus,10000);setInterval(loadForwards,12000)}
(async()=>{if(localStorage.sessionToken){const me=await api('/auth/me');if(me.success){API_PREFIX=normPrefix(me.panelPath||'');forceReset=!!me.mustReset;login.style.display='none';app.style.display='block';init();if(forceReset){switchTab('settings');forceResetTip.style.display='block';}return;}localStorage.removeItem('sessionToken');}login.style.display='block';app.style.display='none';})();
</script>
</body>
</html>
